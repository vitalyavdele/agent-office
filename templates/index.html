<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Office</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:    #12131c;
  --bg2:   #1a1b28;
  --bg3:   #222336;
  --bg4:   #2c2d44;
  --bdr:   rgba(255,255,255,.14);
  --bdr2:  rgba(255,255,255,.26);
  --t1:    #f0f0ff;
  --t2:    rgba(240,240,255,.72);
  --t3:    rgba(240,240,255,.42);
  --acc:   #7c6af5;
  --sans:  -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono:  'Fira Code','Cascadia Code',monospace;
}
html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg); color: var(--t1);
  font-family: var(--sans); font-size: 14px;
  -webkit-font-smoothing: antialiased;
  display: flex; flex-direction: column;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  height: 50px; flex-shrink: 0;
  display: flex; align-items: center; padding: 0 20px;
  justify-content: space-between;
  background: var(--bg2);
  border-bottom: 1px solid var(--bdr);
  z-index: 30;
}
.logo {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; font-weight: 700; letter-spacing: -.4px;
}
.logo-mark {
  width: 28px; height: 28px; border-radius: 9px;
  background: linear-gradient(135deg, #5b4bf0, #a78bfa);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; box-shadow: 0 0 20px rgba(124,106,245,.45);
}
.hdr-right { display: flex; align-items: center; gap: 14px; }
.live-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 12px 4px 9px; border-radius: 99px;
  font-size: 11px; font-weight: 700; letter-spacing: .3px;
  background: rgba(74,222,128,.12); border: 1px solid rgba(74,222,128,.28); color: #4ade80;
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: liveglow 2s infinite; }
@keyframes liveglow { 0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,.7)} 50%{box-shadow:0 0 0 5px rgba(74,222,128,0)} }
.live-badge.off { background: rgba(248,113,113,.1); border-color: rgba(248,113,113,.25); color: #f87171; }
.live-badge.off .live-dot { animation: none; }
.clock { font-size: 13px; color: var(--t3); font-variant-numeric: tabular-nums; font-family: var(--mono); }

/* â”€â”€ WORKSPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.workspace {
  flex-shrink: 0;
  background: var(--bg2);
  border-bottom: 2px solid var(--bdr);
  padding: 14px 16px 12px;
}
.workspace-label {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--t3); margin-bottom: 10px;
}
.agents-row {
  display: flex; gap: 8px;
  overflow-x: auto; padding-bottom: 2px;
}
.agents-row::-webkit-scrollbar { height: 3px; }
.agents-row::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 2px; }

/* â”€â”€ AGENT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.agent-card {
  flex: 1; min-width: 112px; max-width: 155px;
  background: var(--bg3);
  border: 1px solid var(--bdr);
  border-radius: 14px; padding: 14px 10px 10px;
  display: flex; flex-direction: column; align-items: center;
  position: relative; overflow: hidden;
  transition: border-color .35s, box-shadow .35s, background .35s;
  cursor: default;
}
/* Subtle top stripe using agent color */
.agent-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--agent-color, transparent);
  opacity: .5;
}
.agent-card[data-status="thinking"] {
  background: rgba(124,106,245,.1);
  border-color: rgba(124,106,245,.4);
  box-shadow: 0 0 28px rgba(124,106,245,.14);
}
.agent-card[data-status="working"] {
  border-color: rgba(255,255,255,.22);
  box-shadow: 0 0 30px var(--glow-color, rgba(255,255,255,.14));
}
.agent-card[data-status="done"] {
  border-color: rgba(74,222,128,.35);
  box-shadow: 0 0 24px rgba(74,222,128,.1);
}

/* Scene */
.char-scene {
  position: relative; width: 70px; height: 70px;
  display: flex; align-items: flex-end; justify-content: center;
  margin-bottom: 5px;
}
.char-aura {
  position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
  width: 50px; height: 16px; border-radius: 50%;
  opacity: 0; transition: opacity .4s; filter: blur(8px);
}
[data-status="thinking"] .char-aura { opacity: .5; background: #a78bfa; }
[data-status="working"]  .char-aura { opacity: .7; }
[data-status="done"]     .char-aura { opacity: .5; background: #4ade80; }

.char-emoji {
  font-size: 40px; line-height: 1;
  position: relative; z-index: 2; display: block;
  transition: filter .3s;
}
[data-status="idle"]     .char-emoji { animation: char-bob 4s ease-in-out infinite; }
[data-status="thinking"] .char-emoji { animation: char-think 2s ease-in-out infinite; filter: drop-shadow(0 0 8px rgba(167,139,250,.6)); }
[data-status="working"]  .char-emoji { animation: char-work .22s ease-in-out infinite alternate; }
[data-status="done"]     .char-emoji { animation: char-done .65s cubic-bezier(.22,.68,0,1.3) forwards; }

@keyframes char-bob   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
@keyframes char-think { 0%,100%{transform:rotate(-6deg) translateY(-2px)} 50%{transform:rotate(6deg) translateY(-4px)} }
@keyframes char-work  { from{transform:translateX(-2px) rotate(-3deg)} to{transform:translateX(2px) rotate(3deg)} }
@keyframes char-done  { 0%{transform:translateY(0) scale(1)} 35%{transform:translateY(-14px) scale(1.15)} 60%{transform:translateY(-4px)} 80%{transform:translateY(-9px)} 100%{transform:translateY(0) scale(1)} }

.thought-bubble {
  position: absolute; top: -2px; right: 0;
  display: flex; gap: 3px; align-items: center;
  background: rgba(124,106,245,.22); border: 1px solid rgba(124,106,245,.4);
  border-radius: 20px; padding: 4px 8px;
  opacity: 0; transition: opacity .3s; pointer-events: none;
}
[data-status="thinking"] .thought-bubble { opacity: 1; }
.th-dot { width: 5px; height: 5px; border-radius: 50%; background: #c4b5fd; animation: th-pulse 1.1s ease-in-out infinite; }
.th-dot:nth-child(2){ animation-delay:.18s; } .th-dot:nth-child(3){ animation-delay:.36s; }
@keyframes th-pulse { 0%,100%{transform:scale(.7);opacity:.35} 50%{transform:scale(1);opacity:1} }

.char-particles { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
.px-item { position: absolute; font-family: var(--mono); font-size: 10px; font-weight: 700; opacity: 0; white-space: nowrap; }
[data-status="working"] .px-item { opacity: 1; }
[data-status="working"] .px-item:nth-child(1){ animation: px-up 1.2s ease-out infinite;       left:5%;  top:55%; }
[data-status="working"] .px-item:nth-child(2){ animation: px-up 1.5s ease-out infinite .35s;  left:65%; top:40%; }
[data-status="working"] .px-item:nth-child(3){ animation: px-up 1.8s ease-out infinite .7s;   left:28%; top:65%; }
@keyframes px-up { 0%{transform:translateY(0) scale(1);opacity:.9} 100%{transform:translateY(-44px) scale(.7);opacity:0} }

[data-status="done"] .px-item { opacity: 1; }
[data-status="done"] .px-item:nth-child(1){ animation: px-burst 1s ease-out 1; left:10%; top:20%; }
[data-status="done"] .px-item:nth-child(2){ animation: px-burst 1s ease-out .15s 1; left:70%; top:10%; }
[data-status="done"] .px-item:nth-child(3){ animation: px-burst 1s ease-out .3s  1; left:40%; top:0%;  }
@keyframes px-burst { 0%{opacity:1;transform:scale(.8)} 60%{opacity:.8;transform:scale(1.2) translateY(-20px)} 100%{opacity:0;transform:scale(.5) translateY(-36px)} }

.char-info { display: flex; align-items: center; gap: 5px; width: 100%; justify-content: center; margin-top: 3px; }
.char-name { font-size: 12px; font-weight: 700; color: var(--t1); letter-spacing: -.15px; }
.char-badge {
  font-size: 8px; font-weight: 800; letter-spacing: .6px; text-transform: uppercase;
  padding: 2px 7px; border-radius: 99px;
}
.char-badge.idle     { background: rgba(240,240,255,.1);  color: rgba(240,240,255,.45); }
.char-badge.thinking { background: rgba(167,139,250,.22); color: #d4aaff; animation: blink .9s infinite; }
.char-badge.working  { background: rgba(74,222,128,.18);  color: #6ee7a0; }
.char-badge.done     { background: rgba(74,222,128,.18);  color: #6ee7a0; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }

.char-role { font-size: 9px; color: var(--t3); text-align: center; margin-top: 1px; }
.char-task-text {
  font-size: 9.5px; color: var(--t3); text-align: center; margin-top: 4px;
  max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  padding: 0 4px; min-height: 13px;
}
.char-task-text.active { color: var(--t2); }
.char-prog { width: 100%; height: 2px; background: rgba(240,240,255,.08); border-radius: 1px; margin-top: 9px; overflow: hidden; }
.char-prog-fill { height: 100%; border-radius: 1px; width: 0; transition: width .5s ease, background .3s; }
.char-prog-fill.idle     { background: transparent; width: 0 !important; }
.char-prog-fill.thinking { background: #a78bfa; animation: prog-sweep 1.6s ease-in-out infinite; width: 40%; }
.char-prog-fill.working  { background: currentColor; }
.char-prog-fill.done     { background: #4ade80; width: 100% !important; }
@keyframes prog-sweep { 0%{transform:translateX(-200%)} 100%{transform:translateX(350%)} }

/* â”€â”€ EVENT TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ticker-strip {
  flex-shrink: 0; height: 32px;
  background: var(--bg3);
  border-bottom: 1px solid var(--bdr);
  display: flex; align-items: center; overflow: hidden;
}
.ticker-label {
  flex-shrink: 0; padding: 0 12px 0 16px;
  font-size: 9px; font-weight: 800; letter-spacing: 1.2px; text-transform: uppercase;
  color: var(--acc); border-right: 1px solid var(--bdr);
  height: 100%; display: flex; align-items: center; gap: 7px; white-space: nowrap;
}
.ticker-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--acc); animation: blink 1.5s infinite; }
.ticker-track {
  flex: 1; display: flex; align-items: center;
  overflow: hidden;
  mask-image: linear-gradient(to right, transparent 0%, black 4%, black 92%, transparent 100%);
}
.ticker-inner {
  display: flex; gap: 8px; align-items: center; white-space: nowrap;
  padding: 0 16px;
}
.tick-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; border-radius: 99px; font-size: 10px; font-weight: 600;
  border: 1px solid transparent; flex-shrink: 0;
  animation: tick-in .3s ease both;
}
@keyframes tick-in { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }
.tick-sep { color: var(--t3); font-size: 11px; user-select: none; }
.ticker-empty { font-size: 11px; color: var(--t3); padding: 0 8px; }

/* â”€â”€ MAIN BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-body { flex: 1; display: flex; overflow: hidden; }

/* â”€â”€ KANBAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kanban-panel {
  width: 285px; flex-shrink: 0;
  display: flex; flex-direction: column;
  border-right: 1px solid var(--bdr);
  background: var(--bg);
  overflow: hidden;
}
.kanban-header { padding: 14px 16px 10px; border-bottom: 1px solid var(--bdr); flex-shrink: 0; }
.kanban-title { font-size: 11px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; color: var(--t3); }
.kanban-body {
  flex: 1; overflow-y: auto; padding: 10px;
  display: flex; flex-direction: column; gap: 8px;
}
.kanban-body::-webkit-scrollbar { width: 3px; }
.kanban-body::-webkit-scrollbar-thumb { background: var(--bdr); border-radius: 2px; }

.k-col { display: flex; flex-direction: column; gap: 5px; }
.k-col-head {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 6px 4px; position: sticky; top: 0; z-index: 2;
  background: var(--bg);
}
.k-dot { width: 7px; height: 7px; border-radius: 50%; }
.k-col-name { font-size: 10px; font-weight: 800; letter-spacing: .6px; text-transform: uppercase; }
.k-count { font-size: 10px; font-weight: 700; padding: 1px 7px; border-radius: 99px; background: rgba(240,240,255,.08); color: var(--t3); margin-left: auto; }
.k-card {
  background: var(--bg3); border: 1px solid var(--bdr);
  border-radius: 10px; padding: 10px 12px;
  animation: card-in .25s cubic-bezier(.22,.68,0,1.2) both;
  transition: border-color .2s, background .2s;
}
.k-card:hover { border-color: var(--bdr2); background: var(--bg4); }
@keyframes card-in { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }
.k-card-text { font-size: 12.5px; color: var(--t1); line-height: 1.5; }
.k-card-meta { font-size: 10px; color: var(--t3); margin-top: 5px; }
.k-card-summary { font-size: 11px; color: var(--t2); margin-top: 5px; line-height: 1.4; }

.k-dot.pending  { background: #fbbf24; }
.k-dot.active   { background: #a78bfa; }
.k-dot.done2    { background: #4ade80; }
.k-col-head.pending .k-col-name { color: #fbbf24; }
.k-col-head.active  .k-col-name { color: #a78bfa; }
.k-col-head.done2   .k-col-name { color: #4ade80; }

.k-col-divider { height: 1px; background: var(--bdr); margin: 4px 0 8px; }
.k-empty { font-size: 11.5px; color: var(--t3); padding: 6px; text-align: center; }

/* â”€â”€ ACTIVITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.activity-panel {
  flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0;
}
.activity-header { padding: 14px 20px 10px; border-bottom: 1px solid var(--bdr); flex-shrink: 0; }
.activity-title { font-size: 11px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; color: var(--t3); }

.feed {
  flex: 1; overflow-y: auto;
  padding: 16px 20px 12px;
  display: flex; flex-direction: column; gap: 10px;
}
.feed::-webkit-scrollbar { width: 4px; }
.feed::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 2px; }

.empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; opacity: .22; pointer-events: none; text-align: center;
}
.empty-icon { font-size: 38px; }
.empty h2 { font-size: 16px; font-weight: 700; }
.empty p { font-size: 13px; color: var(--t2); line-height: 1.6; max-width: 260px; }

/* User message */
.user-row { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.user-ts { font-size: 10px; color: var(--t3); }
.bubble {
  max-width: 65%;
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  color: #fff; border-radius: 18px 18px 3px 18px;
  padding: 10px 15px; font-size: 14px; line-height: 1.55;
  box-shadow: 0 4px 24px rgba(79,70,229,.3);
}

/* Manager plan */
.plan {
  display: flex; align-items: flex-start; gap: 10px;
  background: rgba(124,106,245,.08); border: 1px solid rgba(124,106,245,.2);
  border-radius: 12px; padding: 10px 14px; font-size: 13px;
}
.plan-who  { color: #c4b5fd; font-weight: 700; flex-shrink: 0; }
.plan-body { flex: 1; color: var(--t2); line-height: 1.6; }
.plan-ts   { flex-shrink: 0; font-size: 10px; color: var(--t3); margin-top: 1px; }

/* Agent message card */
.msg-card {
  background: var(--bg3); border: 1px solid var(--bdr);
  border-radius: 12px; overflow: hidden;
  animation: card-in .28s cubic-bezier(.22,.68,0,1.2) both;
  transition: border-color .2s, background .2s;
}
.msg-card:hover { border-color: var(--bdr2); background: var(--bg4); }
.msg-head {
  display: flex; align-items: center; gap: 9px;
  padding: 11px 14px; cursor: pointer; user-select: none;
}
.msg-av {
  width: 26px; height: 26px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;
}
.msg-name    { font-size: 12.5px; font-weight: 700; flex-shrink: 0; }
.msg-preview { flex: 1; font-size: 12.5px; color: var(--t2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.msg-ts      { font-size: 10px; color: var(--t3); flex-shrink: 0; font-variant-numeric: tabular-nums; }
.msg-chev    { font-size: 10px; color: var(--t3); flex-shrink: 0; margin-left: 3px; transition: transform .2s; }
.msg-card.open .msg-chev { transform: rotate(180deg); }
.msg-body    { display: none; padding: 0 14px 14px; }
.msg-card.open .msg-body { display: block; }
.msg-scroll  { max-height: 480px; overflow-y: auto; padding-right: 4px; border-top: 1px solid var(--bdr); padding-top: 12px; }
.msg-scroll::-webkit-scrollbar { width: 3px; }
.msg-scroll::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 2px; }

/* â”€â”€ MARKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.md { font-size: 13.5px; line-height: 1.78; color: var(--t2); }
.md strong { font-weight: 700; color: var(--t1); }
.md em { font-style: italic; }
.md h1 { font-size: 16px; font-weight: 700; color: var(--t1); margin: 14px 0 6px; }
.md h2 { font-size: 14px; font-weight: 700; color: var(--t1); margin: 12px 0 5px; }
.md h3 { font-size: 13.5px; font-weight: 600; color: var(--t1); margin: 10px 0 4px; }
.md p  { margin-bottom: 9px; }
.md ul, .md ol { padding-left: 20px; margin-bottom: 9px; }
.md li { margin-bottom: 4px; }
.md code { background: rgba(240,240,255,.1); padding: 2px 6px; border-radius: 5px; font-family: var(--mono); font-size: 11.5px; color: #c4b5fd; }
.md pre { background: rgba(0,0,0,.45); border: 1px solid var(--bdr2); border-radius: 10px; padding: 12px 14px; margin: 8px 0; overflow-x: auto; }
.md pre code { background: none; padding: 0; font-size: 12px; color: rgba(240,240,255,.75); }
.md blockquote { border-left: 3px solid rgba(124,106,245,.5); padding-left: 13px; color: var(--t2); margin: 8px 0; }
.md hr { border: none; border-top: 1px solid var(--bdr); margin: 12px 0; }
.md .tw { overflow-x: auto; margin: 8px 0; border-radius: 8px; border: 1px solid var(--bdr); }
.md table { width: 100%; border-collapse: collapse; font-size: 12px; }
.md th, .md td { padding: 7px 12px; border-bottom: 1px solid var(--bdr); text-align: left; }
.md th { background: rgba(240,240,255,.05); font-weight: 700; color: var(--t1); }
.md tr:last-child td { border-bottom: none; }

/* â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-area {
  flex-shrink: 0; padding: 12px 18px 14px;
  border-top: 1px solid var(--bdr);
  background: var(--bg2);
  display: flex; align-items: flex-end; gap: 10px;
}
.mic-btn {
  width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
  background: var(--bg3); border: 1px solid var(--bdr);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--t2); transition: all .2s;
}
.mic-btn:hover { background: var(--bg4); color: var(--t1); border-color: var(--bdr2); }
.mic-btn.recording { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.4); color: #f87171; animation: mic-pulse 1s infinite; }
@keyframes mic-pulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.5)} 50%{box-shadow:0 0 0 8px rgba(239,68,68,0)} }

.input-wrap {
  flex: 1; display: flex; align-items: flex-end; gap: 9px;
  background: var(--bg3); border: 1px solid var(--bdr);
  border-radius: 13px; padding: 10px 10px 10px 15px;
  transition: border-color .2s, box-shadow .2s;
}
.input-wrap:focus-within { border-color: rgba(124,106,245,.5); box-shadow: 0 0 0 3px rgba(124,106,245,.12); }
#ti {
  flex: 1; background: none; border: none; outline: none;
  color: var(--t1); font-family: var(--sans); font-size: 14px;
  resize: none; min-height: 22px; max-height: 90px;
  line-height: 1.5;
}
#ti::placeholder { color: var(--t3); }
.send-btn {
  width: 34px; height: 34px; border-radius: 10px; flex-shrink: 0;
  background: var(--acc); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center; color: #fff;
  transition: background .15s, transform .1s;
}
.send-btn:hover { background: #6355d8; }
.send-btn:active { transform: scale(.87); }
.input-hint { font-size: 10px; color: var(--t3); text-align: center; margin-top: 6px; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-mark">âœ¦</div>
    Agent Office
  </div>
  <div class="hdr-right">
    <div class="live-badge off" id="liveEl"><div class="live-dot"></div><span id="liveText">OFFLINE</span></div>
    <div class="clock" id="clockEl">00:00:00</div>
  </div>
</header>

<div class="workspace">
  <div class="workspace-label">Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°</div>
  <div class="agents-row" id="agentsRow"></div>
</div>

<div class="ticker-strip">
  <div class="ticker-label">
    <div class="ticker-dot"></div>Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ¯
  </div>
  <div class="ticker-track">
    <div class="ticker-inner" id="tickerInner">
      <span class="ticker-empty">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸â€¦</span>
    </div>
  </div>
</div>

<div class="main-body">

  <div class="kanban-panel">
    <div class="kanban-header"><div class="kanban-title">Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸</div></div>
    <div class="kanban-body">
      <div class="k-col">
        <div class="k-col-head pending">
          <div class="k-dot pending"></div>
          <span class="k-col-name">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ</span>
          <span class="k-count" id="cntPending">0</span>
        </div>
        <div class="k-col-divider"></div>
        <div class="k-empty" id="emptyPending">Ğ¿ÑƒÑÑ‚Ğ¾</div>
        <div id="listPending"></div>
      </div>
      <div class="k-col">
        <div class="k-col-head active">
          <div class="k-dot active"></div>
          <span class="k-col-name">Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</span>
          <span class="k-count" id="cntActive">0</span>
        </div>
        <div class="k-col-divider"></div>
        <div class="k-empty" id="emptyActive">Ğ¿ÑƒÑÑ‚Ğ¾</div>
        <div id="listActive"></div>
      </div>
      <div class="k-col">
        <div class="k-col-head done2">
          <div class="k-dot done2"></div>
          <span class="k-col-name">Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</span>
          <span class="k-count" id="cntDone">0</span>
        </div>
        <div class="k-col-divider"></div>
        <div class="k-empty" id="emptyDone">Ğ¿ÑƒÑÑ‚Ğ¾</div>
        <div id="listDone"></div>
      </div>
    </div>
  </div>

  <div class="activity-panel">
    <div class="activity-header"><div class="activity-title">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ</div></div>
    <div class="feed" id="feed">
      <div class="empty" id="emptyEl">
        <div class="empty-icon">âœ¦</div>
        <h2>ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°</h2>
        <p>ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â€” Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ ĞµÑ‘ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸</p>
      </div>
    </div>
  </div>

</div>

<div class="input-area">
  <button class="mic-btn" id="micBtn" title="Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
      <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
      <line x1="12" y1="19" x2="12" y2="23"/>
      <line x1="8" y1="23" x2="16" y2="23"/>
    </svg>
  </button>
  <div style="flex:1;display:flex;flex-direction:column">
    <div class="input-wrap">
      <textarea id="ti" rows="1" placeholder="ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½â€¦"></textarea>
      <button class="send-btn" id="sendBtn" title="Ctrl+Enter">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">Ctrl+Enter Â· Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° Â· Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸</div>
  </div>
</div>

<script>
const AGENTS = {
  'manager':    { name:'Manager',    emoji:'ğŸ¯', color:'#a78bfa', role:'ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',   px:['ğŸ“‹','ğŸ’¡','â­'], glow:'rgba(167,139,250,.32)' },
  'researcher': { name:'Researcher', emoji:'ğŸ”', color:'#60a5fa', role:'Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ', px:['?','!','ğŸŒ'],   glow:'rgba(96,165,250,.32)'  },
  'writer':     { name:'Writer',     emoji:'âœï¸',  color:'#4ade80', role:'ĞĞ²Ñ‚Ğ¾Ñ€',         px:['ğŸ“','âœ¨','ğŸ’¬'],  glow:'rgba(74,222,128,.32)'  },
  'coder':      { name:'Coder',      emoji:'ğŸ’»', color:'#fbbf24', role:'Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº',   px:['{}','</>','01'],glow:'rgba(251,191,36,.32)'  },
  'analyst':    { name:'Analyst',    emoji:'ğŸ“Š', color:'#f87171', role:'ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº',      px:['ğŸ“ˆ','%','âˆ‘'],   glow:'rgba(248,113,113,.32)' },
  'ux-auditor': { name:'UX Auditor', emoji:'ğŸ¨', color:'#fb923c', role:'UI/UX',         px:['âœï¸','â—','ğŸ­'],  glow:'rgba(251,146,60,.32)'  },
  'site-coder': { name:'Site Coder', emoji:'ğŸŒ', color:'#22d3ee', role:'Frontend',      px:['âš¡','<>','âˆ…'],  glow:'rgba(34,211,238,.32)'  },
  'deployer':   { name:'Deployer',   emoji:'ğŸš€', color:'#86efac', role:'DevOps',        px:['ğŸ“¦','âš™ï¸','âœ“'],  glow:'rgba(134,239,172,.32)' },
};
const STATUS_RU = { idle:'IDLE', thinking:'Ğ”Ğ£ĞœĞĞ•Ğ¢', working:'ĞĞšĞ¢Ğ˜Ğ’Ğ•Ğ', done:'Ğ“ĞĞ¢ĞĞ’Ğ' };

let cardsBuilt = false;

function buildAgentCards(serverAgents) {
  const row = document.getElementById('agentsRow');
  row.innerHTML = '';
  const list = (serverAgents && serverAgents.length)
    ? serverAgents
    : Object.keys(AGENTS).map(k => ({ key:k, status:'idle', task:'', progress:0 }));

  list.forEach(a => {
    const d = AGENTS[a.key] || { name:a.name||a.key, emoji:'ğŸ¤–', color:'#888', role:'', px:['â€¦','Â·','â€¢'], glow:'rgba(255,255,255,.15)' };
    const el = document.createElement('div');
    el.className      = 'agent-card';
    el.id             = 'acard-' + a.key;
    el.dataset.agent  = a.key;
    el.dataset.status = a.status || 'idle';
    el.style.setProperty('--glow-color', d.glow);
    el.style.setProperty('--agent-color', d.color);
    el.innerHTML = `
      <div class="char-scene">
        <div class="char-aura" style="background:${d.color}"></div>
        <div class="thought-bubble"><div class="th-dot"></div><div class="th-dot"></div><div class="th-dot"></div></div>
        <div class="char-particles">
          <span class="px-item" style="color:${d.color}">${d.px[0]}</span>
          <span class="px-item" style="color:${d.color}">${d.px[1]}</span>
          <span class="px-item" style="color:${d.color}">${d.px[2]}</span>
        </div>
        <div class="char-emoji">${d.emoji}</div>
      </div>
      <div class="char-info">
        <span class="char-name">${d.name}</span>
        <span class="char-badge idle" id="abadge-${a.key}">IDLE</span>
      </div>
      <div class="char-role">${d.role}</div>
      <div class="char-task-text" id="atask-${a.key}">Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½</div>
      <div class="char-prog">
        <div class="char-prog-fill idle" id="aprog-${a.key}" style="color:${d.color}"></div>
      </div>`;
    row.appendChild(el);
    applyAgentState(a);
  });
}

function applyAgentState(a) {
  const card  = document.getElementById('acard-'  + a.key);
  const badge = document.getElementById('abadge-' + a.key);
  const task  = document.getElementById('atask-'  + a.key);
  const prog  = document.getElementById('aprog-'  + a.key);
  if (!card) return;
  const st = a.status || 'idle';
  card.dataset.status = st;
  card.classList.toggle('glow', st === 'working' || st === 'done');
  badge.className   = 'char-badge ' + st;
  badge.textContent = STATUS_RU[st] || st.toUpperCase();
  task.textContent  = (st !== 'idle' && a.task) ? a.task : 'Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´ĞµĞ½';
  task.className    = 'char-task-text' + (st !== 'idle' ? ' active' : '');
  prog.className    = 'char-prog-fill ' + st;
  if (st === 'working') prog.style.width = (a.progress || 50) + '%';
  else if (st !== 'thinking') prog.style.width = '';
}

/* TICKER */
const tickerEvents = [];
const STATUS_VERB = { thinking:'Ğ´ÑƒĞ¼Ğ°ĞµÑ‚', working:'Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚', done:'ÑĞ´Ğ°Ğ» Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ' };

function pushTick(agentKey, status, taskText) {
  const d = AGENTS[agentKey];
  if (!d || status === 'idle') return;
  const verb = STATUS_VERB[status] || status;
  tickerEvents.push({ emoji:d.emoji, name:d.name, color:d.color, verb, task: taskText || '' });
  if (tickerEvents.length > 20) tickerEvents.shift();
  renderTicker();
}

function renderTicker() {
  const inner = document.getElementById('tickerInner');
  if (!tickerEvents.length) {
    inner.innerHTML = '<span class="ticker-empty">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸â€¦</span>';
    return;
  }
  inner.innerHTML = tickerEvents.slice().reverse().map((ev, i) => {
    const task = ev.task
      ? ` â€” <span style="opacity:.55">${esc(ev.task.slice(0,45))}${ev.task.length>45?'â€¦':''}</span>`
      : '';
    return `<span class="tick-pill" style="color:${ev.color};background:${ev.color}18;border-color:${ev.color}30">${ev.emoji} <b>${ev.name}</b> ${ev.verb}${task}</span>`
         + (i < tickerEvents.length - 1 ? '<span class="tick-sep">Â·</span>' : '');
  }).join('');
}

/* KANBAN */
async function loadTasks() {
  try {
    const r = await fetch('/api/tasks');
    const d = await r.json();
    renderKanban(d.tasks || []);
  } catch(e) {}
}
function renderKanban(tasks) {
  fillCol(tasks.filter(t => t.status === 'pending'),    'listPending', 'cntPending', 'emptyPending');
  fillCol(tasks.filter(t => t.status === 'processing'), 'listActive',  'cntActive',  'emptyActive');
  fillCol(tasks.filter(t => t.status === 'done'),       'listDone',    'cntDone',    'emptyDone');
}
function fillCol(tasks, listId, cntId, emptyId) {
  document.getElementById(cntId).textContent           = tasks.length;
  document.getElementById(emptyId).style.display       = tasks.length ? 'none' : '';
  const list = document.getElementById(listId);
  list.innerHTML = '';
  tasks.slice(0, 20).forEach(t => {
    const d  = new Date(t.created_at);
    const ds = d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})
             + ' ' + d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    const el = document.createElement('div');
    el.className = 'k-card';
    const txt = (t.content||'').slice(0,120) + (t.content&&t.content.length>120?'â€¦':'');
    el.innerHTML = `<div class="k-card-text">${esc(txt)}</div><div class="k-card-meta">${ds}</div>`
                 + (t.summary ? `<div class="k-card-summary">${esc(t.summary.slice(0,80))}</div>` : '');
    list.appendChild(el);
  });
}

/* FEED */
const seen = new Set();
let msgCn = 0;

function addMsg(msg, hist) {
  const k = `${msg.role}|${(msg.content||'').slice(0,80)}`;
  if (seen.has(k)) return;
  seen.add(k);
  const empty = document.getElementById('emptyEl');
  if (empty) empty.remove();
  const feed = document.getElementById('feed');
  const def  = AGENTS[msg.role] || null;
  const col  = msg.color || (def && def.color) || '#888';
  const emo  = msg.emoji || (def && def.emoji) || 'ğŸ¤–';
  const nm   = msg.name  || (def && def.name)  || msg.role;

  if (msg.role === 'user') {
    const el = document.createElement('div');
    el.className = 'user-row';
    el.innerHTML = `<div class="user-ts">${msg.time}</div><div class="bubble">${esc(msg.content)}</div>`;
    feed.appendChild(el);
    if (!hist) feed.scrollTop = feed.scrollHeight;
    return;
  }

  const isPlan = /^\*\*Plan:\*\*|^Plan:/i.test((msg.content||'').trim());
  if (msg.role === 'manager' && isPlan) {
    const txt = msg.content.replace(/^\*\*Plan:\*\*\s*/,'').replace(/^Plan:\s*/i,'');
    const el = document.createElement('div');
    el.className = 'plan';
    el.innerHTML = `<span class="plan-who">ğŸ¯ Manager</span><span class="plan-body">${esc(txt)}</span><span class="plan-ts">${msg.time}</span>`;
    feed.appendChild(el);
    if (!hist) feed.scrollTop = feed.scrollHeight;
    return;
  }

  const id = 'mc' + (++msgCn);
  const preview = (msg.content||'').replace(/[#*`|\n]/g,' ').replace(/\s+/g,' ').trim().slice(0,100);
  const el = document.createElement('div');
  el.className = 'msg-card open';
  el.style.borderColor = col + '25';
  el.innerHTML = `
    <div class="msg-head" onclick="toggleMsg('${id}',this.parentElement)"
         style="background:linear-gradient(90deg,${col}10 0%,transparent 60%)">
      <div class="msg-av" style="background:${col}20">${emo}</div>
      <span class="msg-name" style="color:${col}">${esc(nm)}</span>
      <span class="msg-preview">${esc(preview)}${msg.content.length>100?'â€¦':''}</span>
      <span class="msg-ts">${msg.time}</span>
      <span class="msg-chev">â–¾</span>
    </div>
    <div class="msg-body" id="${id}">
      <div class="msg-scroll"><div class="md">${mdRender(msg.content)}</div></div>
    </div>`;
  feed.querySelectorAll('.msg-card.open').forEach(c => c.classList.remove('open'));
  feed.appendChild(el);
  if (!hist) feed.scrollTop = feed.scrollHeight;
}

function toggleMsg(id, card) { card.classList.toggle('open'); }

/* MARKDOWN */
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function tbl(block) {
  const rows = block.trim().split('\n').filter(r => r.trim());
  if (rows.length < 2) return esc(block);
  const sep  = r => /^[\|\s\-:]+$/.test(r);
  const prow = r => r.replace(/^\||\|$/g,'').split('|').map(c => c.trim());
  let h = '<div class="tw"><table><thead><tr>';
  prow(rows[0]).forEach(c => h += `<th>${c}</th>`);
  h += '</tr></thead><tbody>';
  rows.slice(2).filter(r => !sep(r)).forEach(r => {
    h += '<tr>'; prow(r).forEach(c => h += `<td>${c}</td>`); h += '</tr>';
  });
  return h + '</tbody></table></div>';
}

function mdRender(raw) {
  const cb = [];
  let t = raw.replace(/```[\w]*\n?([\s\S]*?)```/g, (_,c) => { cb.push(c.trim()); return `\x00${cb.length-1}\x00`; });
  t = t.replace(/((?:\|.+\n?)+)/g, b => tbl(b));
  t = t.replace(/`([^`]+)`/g, (_,c) => `<code>${esc(c)}</code>`);
  t = t.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>');
  t = t.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
  t = t.replace(/^---+$/gm,'<hr>');
  t = t.replace(/^[-*]\s+(.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
  t = t.replace(/^>\s+(.+)$/gm,'<blockquote>$1</blockquote>');
  t = t.split(/\n{2,}/).map(c => {
    c = c.trim(); if (!c) return '';
    if (/^<(h[1-3]|ul|ol|hr|blockquote|pre|div|table)/.test(c)) return c;
    return `<p>${c.replace(/\n/g,'<br>')}</p>`;
  }).join('\n');
  t = t.replace(/\x00(\d+)\x00/g, (_,i) => `<pre><code>${esc(cb[+i])}</code></pre>`);
  return t;
}

/* WEBSOCKET */
let ws;
function connect() {
  const p = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${p}://${location.host}/ws`);
  const liv  = document.getElementById('liveEl');
  const livt = document.getElementById('liveText');
  ws.onopen  = () => { liv.className = 'live-badge'; livt.textContent = 'LIVE'; };
  ws.onclose = () => { liv.className = 'live-badge off'; livt.textContent = 'OFFLINE'; setTimeout(connect, 3000); };
  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.type === 'init') {
      buildAgentCards(d.agents); cardsBuilt = true;
      d.agents.forEach(applyAgentState);
      d.history.forEach(m => addMsg(m, true));
      document.getElementById('feed').scrollTop = 999999;
      loadTasks();
    } else if (d.type === 'agents') {
      if (!cardsBuilt) { buildAgentCards(d.agents); cardsBuilt = true; }
      d.agents.forEach(a => {
        const prev   = document.getElementById('acard-' + a.key);
        const prevSt = prev ? prev.dataset.status : 'idle';
        applyAgentState(a);
        if (a.status && a.status !== prevSt && a.status !== 'idle') {
          pushTick(a.key, a.status, a.task || '');
        }
      });
    } else if (d.type === 'chat') {
      addMsg(d.message, false);
    } else if (d.type === 'tasks_update') {
      loadTasks();
    }
  };
}

setInterval(loadTasks, 15000);

function send() {
  const inp = document.getElementById('ti');
  const txt = inp.value.trim();
  if (!txt || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'task', content: txt }));
  inp.value = ''; inp.style.height = 'auto';
}
document.getElementById('sendBtn').addEventListener('click', send);
document.getElementById('ti').addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); send(); }
  setTimeout(() => {
    const el = e.target; el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 90) + 'px';
  });
});

(function initVoice() {
  const btn = document.getElementById('micBtn');
  const SR  = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { btn.style.opacity='.35'; btn.style.cursor='not-allowed'; return; }
  const rec = new SR(); rec.lang='ru-RU'; rec.continuous=false; rec.interimResults=true;
  let running = false;
  rec.onstart  = () => btn.classList.add('recording');
  rec.onend    = () => { btn.classList.remove('recording'); running=false; };
  rec.onerror  = () => { btn.classList.remove('recording'); running=false; };
  rec.onresult = e => {
    let final='', interim='';
    for (let i=0; i<e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const ti = document.getElementById('ti');
    ti.value = final||interim; ti.style.height='auto';
    ti.style.height = Math.min(ti.scrollHeight,90)+'px';
  };
  btn.addEventListener('click', () => {
    if (running) { rec.stop(); running=false; }
    else { try { rec.start(); running=true; } catch(e){} }
  });
})();

(function tick() {
  const n = new Date();
  document.getElementById('clockEl').textContent =
    [n.getHours(),n.getMinutes(),n.getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');
  setTimeout(tick, 1000);
})();

buildAgentCards(null);
cardsBuilt = false;
connect();
loadTasks();
</script>
</body>
</html>
