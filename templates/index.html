<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Office</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'ao': {
          bg:      '#0a0a12',
          card:    '#111120',
          border:  '#1e1e32',
          hover:   '#1a1a2e',
        }
      }
    }
  }
}
</script>
<style>
  body { background:#0a0a12; }
  /* Markdown in dark cards */
  .md-content { color: #b0b8d0; font-size:13px; line-height:1.75; }
  .md-content strong { color:#e2e8f0; font-weight:700; }
  .md-content h1,.md-content h2,.md-content h3 { color:#e2e8f0; font-weight:700; margin:10px 0 4px; }
  .md-content h1 { font-size:16px; } .md-content h2 { font-size:14px; } .md-content h3 { font-size:13px; }
  .md-content p { margin-bottom:8px; }
  .md-content ul,.md-content ol { padding-left:18px; margin-bottom:8px; }
  .md-content li { margin-bottom:3px; }
  .md-content code { background:#1e1e32; color:#c4b5fd; padding:2px 5px; border-radius:4px; font-size:11px; font-family:monospace; }
  .md-content pre { background:#050508; border:1px solid #1e1e32; border-radius:8px; padding:10px 12px; margin:6px 0; overflow-x:auto; }
  .md-content pre code { background:none; padding:0; color:#a8b8d0; font-size:11.5px; }
  .md-content blockquote { border-left:3px solid #6d28d9; padding-left:12px; color:#888aaa; margin:6px 0; }
  .md-content hr { border:none; border-top:1px solid #1e1e32; margin:10px 0; }
  .md-content table { width:100%; border-collapse:collapse; font-size:12px; }
  .md-content th,.md-content td { padding:6px 10px; border-bottom:1px solid #1e1e32; text-align:left; }
  .md-content th { background:#111120; color:#e2e8f0; font-weight:700; }
  /* Animations */
  @keyframes bob    { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
  @keyframes think  { 0%,100%{transform:rotate(-6deg) translateY(-2px)} 50%{transform:rotate(6deg) translateY(-4px)} }
  @keyframes work   { from{transform:translateX(-2px) rotate(-3deg)} to{transform:translateX(2px) rotate(3deg)} }
  @keyframes sweep  { 0%{transform:translateX(-200%)} 100%{transform:translateX(350%)} }
  .anim-bob   { animation:bob   4s ease-in-out infinite; }
  .anim-think { animation:think 2s ease-in-out infinite; filter:drop-shadow(0 0 8px rgba(167,139,250,.6)); }
  .anim-work  { animation:work  .22s ease-in-out infinite alternate; }
  .anim-sweep { animation:sweep 1.6s ease-in-out infinite; }
  /* Scrollbar */
  ::-webkit-scrollbar { width:4px; height:4px; }
  ::-webkit-scrollbar-thumb { background:#1e1e32; border-radius:2px; }
  ::-webkit-scrollbar-track { background:transparent; }
</style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200" x-data="app()" x-init="init()">

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<header class="h-12 flex-shrink-0 flex items-center justify-between px-5 bg-[#0d0d1a] border-b border-[#1e1e32]">
  <div class="flex items-center gap-2.5">
    <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-violet-600 to-violet-400 flex items-center justify-center text-sm shadow-lg shadow-violet-500/30">‚ú¶</div>
    <span class="font-bold text-sm tracking-tight">Agent Office</span>
  </div>
  <div class="flex items-center gap-3">
    <div :class="wsLive
        ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400'
        : 'bg-red-500/10 border-red-500/30 text-red-400'"
         class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10.5px] font-bold border">
      <div :class="wsLive ? 'bg-emerald-400 animate-pulse' : 'bg-red-400'" class="w-1.5 h-1.5 rounded-full"></div>
      <span x-text="wsLive ? 'LIVE' : 'OFFLINE'"></span>
    </div>
    <div class="text-xs text-slate-600 font-mono tabular-nums" x-text="clock"></div>
  </div>
</header>

<!-- ‚îÄ‚îÄ WORKSPACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex-shrink-0 bg-[#0d0d1a] border-b border-[#1e1e32] px-4 pt-3 pb-2.5">
  <div class="text-[9px] font-black tracking-[1.5px] uppercase text-slate-700 mb-2">–†–∞–±–æ—á–∞—è –∑–æ–Ω–∞</div>
  <div class="flex gap-2 overflow-x-auto pb-1">
    <template x-for="a in agents" :key="a.key">
      <div :class="{
              'border-violet-500/40 bg-violet-500/5 shadow-[0_0_20px_rgba(139,92,246,.12)]': a.status==='thinking',
              'shadow-[0_0_24px_var(--glow)]':  a.status==='working',
              'border-emerald-500/35': a.status==='done',
              'border-[#1e1e32]':      a.status==='idle',
           }"
           :style="`--glow: ${AGENTS[a.key]?.glow||'rgba(255,255,255,.1)'}`"
           class="flex-1 min-w-[110px] max-w-[150px] rounded-xl border bg-[#111120] pt-3 pb-2.5 px-2.5 flex flex-col items-center relative overflow-hidden transition-all duration-300 cursor-default">

        <!-- color top stripe -->
        <div class="absolute top-0 left-0 right-0 h-[3px] opacity-60 rounded-t-xl"
             :style="`background:${AGENTS[a.key]?.color||'#888'}`"></div>

        <!-- emoji zone -->
        <div class="relative w-[68px] h-[68px] flex items-end justify-center mb-1">
          <!-- glow -->
          <div class="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-12 h-3 rounded-full blur-md transition-opacity duration-400"
               :style="`background:${AGENTS[a.key]?.color||'#888'};opacity:${a.status==='working'?.7:a.status==='thinking'?.45:0}`"></div>
          <!-- thought dots -->
          <div :class="a.status==='thinking' ? 'opacity-100' : 'opacity-0'"
               class="absolute top-0 right-0 flex gap-0.5 items-center bg-violet-500/20 border border-violet-500/35 rounded-full px-1.5 py-1 transition-opacity duration-300">
            <div class="w-1 h-1 rounded-full bg-violet-300" style="animation:bounce .9s ease-in-out infinite"></div>
            <div class="w-1 h-1 rounded-full bg-violet-300" style="animation:bounce .9s ease-in-out .18s infinite"></div>
            <div class="w-1 h-1 rounded-full bg-violet-300" style="animation:bounce .9s ease-in-out .36s infinite"></div>
          </div>
          <!-- emoji -->
          <div :class="{
                 'anim-bob':   a.status==='idle',
                 'anim-think': a.status==='thinking',
                 'anim-work':  a.status==='working',
               }"
               class="text-[38px] leading-none relative z-10"
               x-text="AGENTS[a.key]?.emoji||'ü§ñ'"></div>
        </div>

        <!-- name + badge -->
        <div class="flex items-center gap-1 mt-0.5">
          <span class="text-[11.5px] font-bold text-slate-200" x-text="AGENTS[a.key]?.name||a.key"></span>
          <span :class="{
                  'bg-slate-700/60 text-slate-600':             a.status==='idle',
                  'bg-violet-500/20 text-violet-300 animate-pulse': a.status==='thinking',
                  'bg-emerald-500/20 text-emerald-400':          a.status==='working'||a.status==='done',
                }"
                class="text-[7.5px] font-black tracking-[.5px] uppercase px-1.5 py-[2px] rounded-full"
                x-text="STATUS_RU[a.status]||a.status.toUpperCase()"></span>
        </div>

        <div class="text-[9px] text-slate-700 mt-0.5" x-text="AGENTS[a.key]?.role||''"></div>
        <div class="text-[9px] mt-1 truncate w-full text-center px-1 min-h-[12px]"
             :class="a.status!=='idle' ? 'text-slate-400' : 'text-slate-700'"
             x-text="a.status!=='idle'&&a.task ? a.task : '–°–≤–æ–±–æ–¥–µ–Ω'"></div>

        <!-- progress bar -->
        <div class="w-full h-[2px] bg-[#1e1e32] rounded-full mt-2 overflow-hidden">
          <div :class="{
                 'w-0 bg-transparent':     a.status==='idle',
                 'anim-sweep w-[40%] bg-violet-400': a.status==='thinking',
                 'bg-current':             a.status==='working',
                 'w-full bg-emerald-400':  a.status==='done',
               }"
               :style="`color:${AGENTS[a.key]?.color};${a.status==='working'?'width:'+(a.progress||50)+'%':''}`"
               class="h-full rounded-full transition-all duration-500"></div>
        </div>
      </div>
    </template>
  </div>
</div>

<!-- ‚îÄ‚îÄ EVENT TICKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex-shrink-0 h-8 bg-[#07070f] border-b border-[#1e1e32] flex items-center overflow-hidden">
  <div class="flex-shrink-0 h-full flex items-center gap-1.5 px-3 border-r border-[#1e1e32] text-[9px] font-black tracking-[1.4px] uppercase text-violet-500">
    <div class="w-1.5 h-1.5 rounded-full bg-violet-500 animate-pulse"></div>
    –°–û–ë–´–¢–ò–Ø
  </div>
  <div class="flex-1 overflow-hidden px-3 [mask-image:linear-gradient(to_right,transparent_0%,black_5%,black_92%,transparent_100%)]">
    <div class="flex gap-2 items-center whitespace-nowrap">
      <template x-if="tickerEvents.length === 0">
        <span class="text-xs text-slate-700">–û–∂–∏–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤‚Ä¶</span>
      </template>
      <template x-for="(ev,i) in [...tickerEvents].reverse()" :key="i">
        <span :style="`color:${ev.color};background:${ev.color}18;border-color:${ev.color}30`"
              class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[10px] font-semibold">
          <span x-text="ev.emoji"></span>
          <b x-text="ev.name"></b>
          <span x-text="ev.verb"></span>
        </span>
      </template>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex-1 flex overflow-hidden">

  <!-- KANBAN -->
  <div class="w-[270px] flex-shrink-0 flex flex-col bg-[#0d0d1a] border-r border-[#1e1e32]">
    <div class="px-4 py-3 border-b border-[#1e1e32]">
      <div class="text-[10px] font-black tracking-[1.2px] uppercase text-slate-700">–ó–∞–¥–∞—á–∏</div>
    </div>
    <div class="flex-1 overflow-y-auto p-2.5 flex flex-col gap-4">

      <template x-for="col in kanbanCols" :key="col.key">
        <div>
          <div class="flex items-center gap-2 px-1 py-1 sticky top-0 bg-[#0d0d1a] z-10">
            <div class="w-2 h-2 rounded-full" :style="`background:${col.color}`"></div>
            <span class="text-[10px] font-black tracking-[.6px] uppercase" :style="`color:${col.color}`" x-text="col.label"></span>
            <span class="ml-auto text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-[#1e1e32] text-slate-500" x-text="col.tasks.length"></span>
          </div>
          <div class="h-px bg-[#1e1e32] mx-1 mb-1.5"></div>
          <div x-show="col.tasks.length===0" class="text-xs text-slate-700 text-center py-1">–ø—É—Å—Ç–æ</div>
          <template x-for="t in col.tasks" :key="t.id">
            <div :style="col.key==='active' ? 'border-color:'+col.color+'33' : ''"
                 class="bg-[#111120] border border-[#1e1e32] rounded-xl p-2.5 mb-1.5 hover:border-slate-600 transition-colors">
              <div class="text-[12.5px] text-slate-200 leading-snug" x-text="t.content.slice(0,100)+(t.content.length>100?'‚Ä¶':'')"></div>
              <div class="text-[10px] text-slate-600 mt-1.5" x-text="fmtDate(t.created_at)"></div>
              <div x-show="t.summary" class="text-[11px] text-slate-400 mt-1 leading-snug" x-text="t.summary?t.summary.slice(0,80):''"></div>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>

  <!-- FEED -->
  <div class="flex-1 flex flex-col overflow-hidden bg-[#0a0a12]">
    <div class="px-5 py-3 border-b border-[#1e1e32] flex-shrink-0">
      <div class="text-[10px] font-black tracking-[1.2px] uppercase text-slate-700">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
    </div>
    <div class="flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-2.5" x-ref="feed">

      <!-- empty state -->
      <div x-show="messages.length===0" class="flex-1 flex flex-col items-center justify-center h-full opacity-[.18]">
        <div class="text-[36px] mb-2">‚ú¶</div>
        <div class="text-base font-bold">–ö–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞</div>
        <div class="text-sm text-slate-400 text-center mt-1 max-w-xs leading-relaxed">–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –µ—ë –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏</div>
      </div>

      <template x-for="(msg, idx) in messages" :key="idx">
        <div>

          <!-- User bubble -->
          <div x-show="msg.role==='user'" class="flex flex-col items-end gap-1">
            <div class="text-[10px] text-slate-700" x-text="msg.time"></div>
            <div class="max-w-[65%] bg-gradient-to-br from-violet-600 to-purple-700 text-white rounded-[18px] rounded-tr-[4px] px-4 py-2.5 text-[13.5px] leading-relaxed shadow-lg shadow-violet-600/20"
                 x-text="msg.content"></div>
          </div>

          <!-- Manager plan -->
          <div x-show="msg.role==='manager' && isPlan(msg.content)"
               class="flex items-start gap-2.5 bg-violet-500/8 border border-violet-500/18 border-l-[3px] border-l-violet-500 rounded-xl p-3 text-[13px]">
            <span class="font-bold text-violet-400 flex-shrink-0">üéØ Manager</span>
            <span class="flex-1 text-slate-300 leading-relaxed" x-text="stripPlan(msg.content)"></span>
            <span class="flex-shrink-0 text-[10px] text-slate-600 mt-0.5" x-text="msg.time"></span>
          </div>

          <!-- Agent result card ‚Äî always expanded -->
          <div x-show="msg.role!=='user' && !(msg.role==='manager' && isPlan(msg.content))"
               :style="`border-left-color:${msg.color||AGENTS[msg.role]?.color||'#7c6af5'}`"
               class="bg-[#111120] border border-[#1e1e32] border-l-[3px] rounded-xl overflow-hidden hover:border-slate-700 transition-colors">
            <!-- card header -->
            <div class="flex items-center gap-2.5 px-3.5 py-2.5 cursor-pointer select-none"
                 :style="`background:linear-gradient(90deg,${msg.color||AGENTS[msg.role]?.color||'#7c6af5'}12 0%,transparent 60%)`"
                 @click="msg.open = !msg.open">
              <div class="w-7 h-7 rounded-lg flex items-center justify-center text-[15px] flex-shrink-0"
                   :style="`background:${msg.color||AGENTS[msg.role]?.color||'#7c6af5'}22`"
                   x-text="msg.emoji||AGENTS[msg.role]?.emoji||'ü§ñ'"></div>
              <span class="text-[13px] font-bold flex-shrink-0"
                    :style="`color:${msg.color||AGENTS[msg.role]?.color||'#a78bfa'}`"
                    x-text="msg.name||AGENTS[msg.role]?.name||msg.role"></span>
              <span class="flex-1 text-xs text-slate-500 truncate min-w-0"
                    x-text="(msg.content||'').replace(/[#*`|\n]/g,' ').replace(/\s+/g,' ').trim().slice(0,90)"></span>
              <span class="text-[10px] text-slate-600 flex-shrink-0 tabular-nums" x-text="msg.time"></span>
              <span class="text-[10px] text-slate-600 flex-shrink-0 transition-transform duration-200 ml-1"
                    :class="msg.open!==false?'rotate-180':''">‚ñæ</span>
            </div>
            <!-- card body -->
            <div x-show="msg.open!==false" class="px-4 pb-4 pt-3 border-t border-[#1e1e32]">
              <div class="md-content" x-html="renderMd(msg.content)"></div>
            </div>
          </div>

        </div>
      </template>
    </div>
  </div>

</div>

<!-- ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex-shrink-0 border-t border-[#1e1e32] bg-[#0d0d1a] px-4 py-3 flex items-end gap-3">
  <button @click="toggleMic()" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥"
          :class="micActive
            ? 'bg-red-500/15 border-red-500/35 text-red-400 animate-pulse'
            : 'bg-[#111120] border-[#1e1e32] text-slate-500 hover:text-slate-300 hover:bg-[#1a1a2e]'"
          class="w-10 h-10 rounded-full border flex items-center justify-center flex-shrink-0 transition-all">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
      <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
      <line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
    </svg>
  </button>

  <div class="flex-1 flex flex-col gap-1.5">
    <div class="flex items-end gap-2 bg-[#111120] border border-[#1e1e32] rounded-xl px-4 py-2.5 transition-all focus-within:border-violet-500/40 focus-within:ring-1 focus-within:ring-violet-500/15">
      <textarea x-ref="ta" x-model="inputText"
                @keydown.ctrl.enter.prevent="sendTask()"
                @input="resizeTA()"
                rows="1"
                placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –∑–∞–∂–º–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω‚Ä¶"
                class="flex-1 bg-transparent border-none outline-none text-[14px] text-slate-100 placeholder-slate-700 resize-none min-h-[22px] max-h-[90px] leading-relaxed font-sans"></textarea>
      <button @click="sendTask()"
              class="w-8 h-8 rounded-lg bg-violet-600 hover:bg-violet-500 active:scale-90 flex items-center justify-center flex-shrink-0 transition-all">
        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="text-[10px] text-slate-800 text-center">Ctrl+Enter ¬∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–ª—è –≥–æ–ª–æ—Å–∞ ¬∑ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ALPINE APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
function app() {
  return {

    /* ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    wsLive:       false,
    clock:        '00:00:00',
    agents:       [],
    messages:     [],
    allTasks:     [],
    tickerEvents: [],
    inputText:    '',
    micActive:    false,
    ws:           null,

    /* ‚îÄ‚îÄ‚îÄ Agent catalog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    AGENTS: {
      'manager':    { name:'Manager',    emoji:'üéØ', color:'#a78bfa', role:'–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä',   glow:'rgba(167,139,250,.3)' },
      'researcher': { name:'Researcher', emoji:'üîç', color:'#60a5fa', role:'–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', glow:'rgba(96,165,250,.3)'  },
      'writer':     { name:'Writer',     emoji:'‚úçÔ∏è',  color:'#4ade80', role:'–ê–≤—Ç–æ—Ä',         glow:'rgba(74,222,128,.3)'  },
      'coder':      { name:'Coder',      emoji:'üíª', color:'#fbbf24', role:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',   glow:'rgba(251,191,36,.3)'  },
      'analyst':    { name:'Analyst',    emoji:'üìä', color:'#f87171', role:'–ê–Ω–∞–ª–∏—Ç–∏–∫',      glow:'rgba(248,113,113,.3)' },
      'ux-auditor': { name:'UX Auditor', emoji:'üé®', color:'#fb923c', role:'UI/UX',         glow:'rgba(251,146,60,.3)'  },
      'site-coder': { name:'Site Coder', emoji:'üåê', color:'#22d3ee', role:'Frontend',      glow:'rgba(34,211,238,.3)'  },
      'deployer':   { name:'Deployer',   emoji:'üöÄ', color:'#86efac', role:'DevOps',        glow:'rgba(134,239,172,.3)' },
    },
    STATUS_RU: { idle:'IDLE', thinking:'–î–£–ú–ê–ï–¢', working:'–ê–ö–¢–ò–í–ï–ù', done:'–ì–û–¢–û–í–û' },
    VERB:      { thinking:'–¥—É–º–∞–µ—Ç', working:'—Ä–∞–±–æ—Ç–∞–µ—Ç', done:'–∑–∞–≤–µ—Ä—à–∏–ª' },

    /* ‚îÄ‚îÄ‚îÄ Computed: kanban columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    get kanbanCols() {
      return [
        { key:'pending', label:'–û–∂–∏–¥–∞–Ω–∏–µ', color:'#fbbf24', tasks: this.allTasks.filter(t=>t.status==='pending') },
        { key:'active',  label:'–í —Ä–∞–±–æ—Ç–µ', color:'#a78bfa', tasks: this.allTasks.filter(t=>t.status==='processing') },
        { key:'done',    label:'–ì–æ—Ç–æ–≤–æ',   color:'#4ade80', tasks: this.allTasks.filter(t=>t.status==='done') },
      ];
    },

    /* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    init() {
      this.buildAgents();
      this.connect();
      this.loadTasks();
      this.startClock();
      this.initVoice();
      setInterval(() => this.loadTasks(), 10000);
    },

    buildAgents() {
      this.agents = Object.keys(this.AGENTS).map(k => ({
        key: k, status: 'idle', task: '', progress: 0,
      }));
    },

    /* ‚îÄ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    connect() {
      const p = location.protocol === 'https:' ? 'wss' : 'ws';
      this.ws = new WebSocket(`${p}://${location.host}/ws`);
      this.ws.onopen  = () => { this.wsLive = true; };
      this.ws.onclose = () => { this.wsLive = false; setTimeout(() => this.connect(), 3000); };
      this.ws.onmessage = e => {
        const d = JSON.parse(e.data);
        if (d.type === 'init') {
          // merge server agents into local
          d.agents.forEach(a => this.applyAgent(a));
          // load history ‚Äî all open by default
          this.messages = d.history.map(m => ({ ...m, open: true }));
          this.$nextTick(() => this.scrollFeed());
          this.loadTasks();
        } else if (d.type === 'agents') {
          d.agents.forEach(a => {
            const prev = this.agents.find(x => x.key === a.key);
            const prevSt = prev?.status || 'idle';
            this.applyAgent(a);
            if (a.status && a.status !== prevSt && a.status !== 'idle') {
              this.pushTick(a.key, a.status, a.task || '');
            }
          });
        } else if (d.type === 'chat') {
          this.messages.push({ ...d.message, open: true });
          this.$nextTick(() => this.scrollFeed());
        } else if (d.type === 'tasks_update') {
          this.loadTasks();
        }
      };
    },

    applyAgent(a) {
      const idx = this.agents.findIndex(x => x.key === a.key);
      if (idx >= 0) {
        this.agents[idx] = { ...this.agents[idx], ...a };
      } else {
        this.agents.push({ key: a.key, status: 'idle', task: '', progress: 0, ...a });
      }
    },

    scrollFeed() {
      const f = this.$refs.feed;
      if (f) f.scrollTop = f.scrollHeight;
    },

    /* ‚îÄ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async loadTasks() {
      try {
        const r = await fetch('/api/tasks');
        const d = await r.json();
        this.allTasks = d.tasks || [];
      } catch(e) {}
    },

    fmtDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})
           + ' ' + d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    },

    /* ‚îÄ‚îÄ‚îÄ Ticker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    pushTick(key, status, task) {
      const d = this.AGENTS[key];
      if (!d || status === 'idle') return;
      this.tickerEvents.push({
        emoji: d.emoji, name: d.name, color: d.color,
        verb: this.VERB[status] || status, task,
      });
      if (this.tickerEvents.length > 20) this.tickerEvents.shift();
    },

    /* ‚îÄ‚îÄ‚îÄ Feed helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    isPlan(content) {
      return /^\*\*Plan:\*\*|^Plan:/i.test((content||'').trim());
    },
    stripPlan(content) {
      return (content||'').replace(/^\*\*Plan:\*\*\s*/,'').replace(/^Plan:\s*/i,'');
    },

    /* ‚îÄ‚îÄ‚îÄ Markdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    renderMd(raw) {
      if (!raw) return '';
      const cb = [];
      let t = raw.replace(/```[\w]*\n?([\s\S]*?)```/g, (_,c) => { cb.push(c.trim()); return `\x00${cb.length-1}\x00`; });
      t = t.replace(/`([^`]+)`/g, (_,c) => `<code>${this.esc(c)}</code>`);
      t = t.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>');
      t = t.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
      t = t.replace(/^---+$/gm,'<hr>');
      t = t.replace(/^[-*]\s+(.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
      t = t.replace(/^>\s+(.+)$/gm,'<blockquote>$1</blockquote>');
      t = t.split(/\n{2,}/).map(c => {
        c = c.trim(); if (!c) return '';
        if (/^<(h[1-3]|ul|ol|hr|blockquote|pre)/.test(c)) return c;
        return `<p>${c.replace(/\n/g,'<br>')}</p>`;
      }).join('');
      t = t.replace(/\x00(\d+)\x00/g, (_,i) => `<pre><code>${this.esc(cb[+i])}</code></pre>`);
      return t;
    },
    esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); },

    /* ‚îÄ‚îÄ‚îÄ Send task ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    sendTask() {
      const txt = this.inputText.trim();
      if (!txt || !this.ws || this.ws.readyState !== 1) return;
      this.ws.send(JSON.stringify({ type: 'task', content: txt }));
      this.inputText = '';
      this.$nextTick(() => {
        const ta = this.$refs.ta;
        if (ta) { ta.style.height = 'auto'; }
      });
    },

    resizeTA() {
      const ta = this.$refs.ta;
      if (!ta) return;
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 90) + 'px';
    },

    /* ‚îÄ‚îÄ‚îÄ Voice ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    _rec: null,
    _recRunning: false,
    initVoice() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return;
      const rec = new SR();
      rec.lang = 'ru-RU'; rec.continuous = false; rec.interimResults = true;
      rec.onstart  = () => { this.micActive = true; };
      rec.onend    = () => { this.micActive = false; this._recRunning = false; };
      rec.onerror  = () => { this.micActive = false; this._recRunning = false; };
      rec.onresult = e => {
        let final = '', interim = '';
        for (let i = 0; i < e.results.length; i++) {
          if (e.results[i].isFinal) final   += e.results[i][0].transcript;
          else                      interim += e.results[i][0].transcript;
        }
        this.inputText = final || interim;
        this.$nextTick(() => this.resizeTA());
      };
      this._rec = rec;
    },
    toggleMic() {
      if (!this._rec) return;
      if (this._recRunning) { this._rec.stop(); this._recRunning = false; }
      else { try { this._rec.start(); this._recRunning = true; } catch(e){} }
    },

    /* ‚îÄ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    startClock() {
      const tick = () => {
        const n = new Date();
        this.clock = [n.getHours(),n.getMinutes(),n.getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');
        setTimeout(tick, 1000);
      };
      tick();
    },

  }; // end return
}
</script>
</body>
</html>
