<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Office HQ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:   #0d0d14;
  --bg2:  #111118;
  --card: rgba(255,255,255,.03);
  --bdr:  rgba(255,255,255,.07);
  --text: #dde3ed;
  --dim:  #5a6a82;
  --dim2: #7a8a9e;
}

html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Inter', system-ui, sans-serif;
  display: flex; flex-direction: column;
}
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 40% at 8% 15%, rgba(124,58,237,.06) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 92% 85%, rgba(56,189,248,.04) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  height: 52px; flex-shrink: 0;
  background: rgba(13,13,20,.97);
  border-bottom: 1px solid var(--bdr);
  display: flex; align-items: center; padding: 0 20px;
  justify-content: space-between; position: relative; z-index: 10;
}
.logo {
  font-size: 14px; font-weight: 700; letter-spacing: -.2px;
  background: linear-gradient(135deg,#a78bfa 0%,#60a5fa 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.hdr-right { display: flex; align-items: center; gap: 18px; }
.live {
  font-size: 11px; font-weight: 600; color: #4ade80;
  display: flex; align-items: center; gap: 6px;
}
.live::before {
  content: ''; width: 7px; height: 7px; border-radius: 50%;
  background: #4ade80; animation: livepulse 2s infinite;
}
.live.off { color: #f87171; }
.live.off::before { background: #f87171; animation: none; }
@keyframes livepulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(74,222,128,.4); }
  60%     { box-shadow: 0 0 0 7px rgba(74,222,128,0); }
}
.clock { font-size: 12px; color: var(--dim2); font-variant-numeric: tabular-nums; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.main { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 1; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: 240px; flex-shrink: 0;
  border-right: 1px solid var(--bdr);
  padding: 14px 10px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 6px;
}
.sec-label {
  font-size: 9px; font-weight: 700; color: var(--dim);
  text-transform: uppercase; letter-spacing: 1.5px; padding: 2px 4px;
  margin-top: 4px;
}

/* Agent card ‚Äî manager */
.a-manager {
  background: var(--card); border: 1px solid rgba(167,139,250,.15);
  border-radius: 10px; padding: 11px 12px;
  display: flex; align-items: center; gap: 10px;
  transition: border-color .4s, box-shadow .4s;
}
.a-manager.working, .a-manager.thinking {
  border-color: rgba(167,139,250,.35);
  box-shadow: 0 0 14px rgba(167,139,250,.06);
}
.workers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.a-worker {
  background: var(--card); border: 1px solid var(--bdr);
  border-radius: 10px; padding: 10px;
  transition: border-color .4s;
}
.a-worker.working { border-color: rgba(255,255,255,.13); }
.a-worker.done    { border-color: rgba(74,222,128,.25); }

.av    { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
.av-sm { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0; }

.badge {
  font-size: 8px; font-weight: 700; padding: 2px 6px;
  border-radius: 99px; text-transform: uppercase; letter-spacing: .4px; white-space: nowrap;
}
.badge.idle     { background: rgba(90,106,130,.15);  color: var(--dim2); }
.badge.thinking { background: rgba(167,139,250,.15); color: #a78bfa; animation: blink .9s infinite; }
.badge.working  { background: rgba(74,222,128,.12);  color: #4ade80; }
.badge.done     { background: rgba(74,222,128,.18);  color: #4ade80; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

.a-info { flex: 1; min-width: 0; }
.a-name { font-size: 12px; font-weight: 600; color: #e2e8f0; }
.a-role { font-size: 10px; color: var(--dim); margin-top: 1px; }
.a-task {
  font-size: 10px; color: var(--dim); margin-top: 5px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.a-task.on { color: var(--dim2); }
.act-bar { height: 2px; background: rgba(255,255,255,.05); border-radius: 1px; margin-top: 8px; overflow: hidden; }
.act-fill { height: 100%; border-radius: 1px; transition: width .6s, background .4s; }
.act-fill.idle     { width: 0; background: transparent; }
.act-fill.thinking { background: #a78bfa; animation: slide 1.4s infinite; }
.act-fill.working  { background: #4ade80; }
.act-fill.done     { background: #4ade80; width: 100% !important; }
@keyframes slide {
  0%   { transform: translateX(-100%); width: 50%; }
  100% { transform: translateX(220%);  width: 50%; }
}

/* ‚îÄ‚îÄ RESULTS PANEL ‚îÄ‚îÄ */
.panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.results {
  flex: 1; overflow-y: auto;
  padding: 14px 16px 8px;
  display: flex; flex-direction: column; gap: 8px;
}

/* empty state */
.empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; opacity: .3; pointer-events: none; text-align: center;
}
.empty-icon  { font-size: 40px; }
.empty-title { font-size: 14px; font-weight: 600; }
.empty-sub   { font-size: 12px; color: var(--dim); }

/* User message */
.user-wrap  { display: flex; flex-direction: column; align-items: flex-end; }
.user-meta  { font-size: 10px; color: var(--dim); margin-bottom: 3px; }
.user-msg {
  max-width: 68%;
  background: linear-gradient(135deg, #3730a3, #5b21b6);
  color: #e0d9ff; border-radius: 12px 12px 3px 12px;
  padding: 9px 13px; font-size: 13.5px; line-height: 1.6;
}

/* Plan bar */
.plan-bar {
  display: flex; align-items: flex-start; gap: 8px;
  background: rgba(167,139,250,.05); border: 1px solid rgba(167,139,250,.12);
  border-radius: 8px; padding: 8px 12px; font-size: 12px;
}
.plan-badge { color: #a78bfa; font-weight: 600; flex-shrink: 0; font-size: 11px; }
.plan-text  { flex: 1; color: var(--dim2); line-height: 1.5; }
.plan-time  { flex-shrink: 0; font-size: 10px; color: var(--dim); font-variant-numeric: tabular-nums; }

/* Result card */
.result-card {
  border-radius: 12px; border: 1px solid var(--bdr);
  background: rgba(255,255,255,.02); overflow: hidden;
  animation: fadein .25s ease;
}
.result-card:hover { border-color: rgba(255,255,255,.11); }

.rc-header {
  display: flex; align-items: center; gap: 9px;
  padding: 11px 13px; cursor: pointer; user-select: none;
  transition: background .15s;
}
.rc-header:hover { background: rgba(255,255,255,.025); }

.rc-av {
  width: 26px; height: 26px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; flex-shrink: 0;
}
.rc-name    { font-size: 12px; font-weight: 700; flex-shrink: 0; }
.rc-preview {
  flex: 1; font-size: 12px; color: var(--dim2);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
}
.rc-time    { font-size: 10px; color: var(--dim); flex-shrink: 0; font-variant-numeric: tabular-nums; }
.rc-arrow   { font-size: 10px; color: var(--dim); flex-shrink: 0; margin-left: 2px; transition: transform .2s; }
.result-card.open .rc-arrow { transform: rotate(180deg); }

.rc-body {
  display: none;
  padding: 0 14px 14px;
}
.result-card.open .rc-body { display: block; }

/* Scrollable content inside card */
.rc-scroll {
  max-height: 480px;
  overflow-y: auto;
  padding-right: 6px;
  border-top: 1px solid var(--bdr);
  padding-top: 12px;
}
.rc-scroll::-webkit-scrollbar { width: 3px; }
.rc-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

/* Markdown */
.md { font-size: 13.5px; line-height: 1.75; color: var(--text); }
.md strong { font-weight: 600; color: #f1f5f9; }
.md em     { color: #94a3b8; font-style: italic; }
.md h1 { font-size: 17px; font-weight: 700; color: #f8fafc; margin: 14px 0 7px; }
.md h2 { font-size: 15px; font-weight: 600; color: #f1f5f9; margin: 12px 0 6px; }
.md h3 { font-size: 13.5px; font-weight: 600; color: #e2e8f0; margin: 10px 0 5px; }
.md p  { margin-bottom: 9px; }
.md ul,.md ol { padding-left: 20px; margin-bottom: 9px; }
.md li { margin-bottom: 4px; }
.md code {
  background: rgba(255,255,255,.09); padding: 2px 6px;
  border-radius: 4px; font-family: 'Fira Code','Courier New',monospace; font-size: 12px;
  color: #c4b5fd;
}
.md pre {
  background: rgba(0,0,0,.45); border: 1px solid var(--bdr);
  border-radius: 8px; padding: 12px 14px; margin: 8px 0; overflow-x: auto;
}
.md pre code { background: none; padding: 0; font-size: 12px; color: #e2e8f0; }
.md blockquote {
  border-left: 3px solid rgba(167,139,250,.35); padding-left: 12px;
  color: var(--dim2); margin: 8px 0; font-style: italic;
}
.md hr { border: none; border-top: 1px solid var(--bdr); margin: 12px 0; }

/* Tables */
.md .tbl-wrap { overflow-x: auto; margin: 10px 0; border-radius: 8px; border: 1px solid var(--bdr); }
.md table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
.md th,.md td { padding: 7px 12px; border-bottom: 1px solid var(--bdr); text-align: left; }
.md th { background: rgba(255,255,255,.04); font-weight: 600; color: #f1f5f9; border-bottom-color: rgba(255,255,255,.1); }
.md tr:last-child td { border-bottom: none; }
.md tr:hover td { background: rgba(255,255,255,.02); }

@keyframes fadein {
  from { opacity: 0; transform: translateY(5px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-area {
  border-top: 1px solid var(--bdr);
  padding: 10px 16px 13px;
  background: rgba(13,13,20,.8);
}
.input-row { display: flex; gap: 9px; align-items: flex-end; }
.input-box {
  flex: 1; background: rgba(255,255,255,.04); border: 1px solid var(--bdr);
  border-radius: 10px; padding: 10px 13px; color: var(--text);
  font-family: inherit; font-size: 14px; resize: none;
  min-height: 42px; max-height: 120px; line-height: 1.5;
  transition: border-color .2s; outline: none;
}
.input-box:focus { border-color: rgba(167,139,250,.35); }
.input-box::placeholder { color: var(--dim); }
.send-btn {
  width: 42px; height: 42px; border-radius: 10px;
  background: #4f46e5; border: none; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; color: #fff; transition: background .2s, transform .1s;
}
.send-btn:hover  { background: #4338ca; }
.send-btn:active { transform: scale(.92); }
.input-hint { font-size: 10px; color: var(--dim); margin-top: 5px; }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tab-bar {
  display: flex; align-items: center; gap: 2px;
  padding: 8px 16px 0; border-bottom: 1px solid var(--bdr);
  flex-shrink: 0;
}
.tab-btn {
  font-size: 12px; font-weight: 500; color: var(--dim2);
  padding: 6px 14px; border-radius: 8px 8px 0 0;
  border: none; background: none; cursor: pointer;
  border-bottom: 2px solid transparent; margin-bottom: -1px;
  transition: color .15s, border-color .15s;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: #a78bfa; border-bottom-color: #a78bfa; }

.tab-panel { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.tab-panel.active { display: flex; }

/* Tasks list */
.tasks-list {
  flex: 1; overflow-y: auto; padding: 14px 16px;
  display: flex; flex-direction: column; gap: 8px;
}
.task-row {
  background: rgba(255,255,255,.025); border: 1px solid var(--bdr);
  border-radius: 10px; padding: 10px 14px;
  display: flex; align-items: flex-start; gap: 12px;
  cursor: default; transition: border-color .15s;
}
.task-row:hover { border-color: rgba(255,255,255,.1); }
.task-row-left { flex: 1; min-width: 0; }
.task-content {
  font-size: 13px; color: var(--text); line-height: 1.5;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.task-meta { font-size: 10px; color: var(--dim); margin-top: 3px; }
.task-summary { font-size: 11px; color: var(--dim2); margin-top: 4px; line-height: 1.5; }
.task-status {
  font-size: 9px; font-weight: 700; padding: 3px 8px;
  border-radius: 99px; text-transform: uppercase; letter-spacing: .4px;
  white-space: nowrap; flex-shrink: 0; margin-top: 1px;
}
.task-status.processing { background: rgba(167,139,250,.15); color: #a78bfa; }
.task-status.done       { background: rgba(74,222,128,.12);  color: #4ade80; }
.task-status.pending    { background: rgba(250,204,21,.1);   color: #facc15; }

.tasks-empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; opacity: .3; text-align: center;
}

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.07); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">üè¢ Agent Office HQ</div>
  <div class="hdr-right">
    <div class="live" id="liveEl">LIVE</div>
    <div class="clock" id="clockEl">00:00:00</div>
  </div>
</header>

<div class="main">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sec-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</div>
    <div class="a-manager idle" id="card-manager">
      <div class="av" style="background:rgba(167,139,250,.12)">üéØ</div>
      <div class="a-info">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">
          <span class="a-name">Manager</span>
          <span class="badge idle" id="badge-manager">IDLE</span>
        </div>
        <div class="a-role">Orchestrator</div>
        <div class="a-task" id="task-manager">–û–∂–∏–¥–∞–µ—Ç –∑–∞–¥–∞—á—É</div>
        <div class="act-bar"><div class="act-fill idle" id="fill-manager" style="width:0%"></div></div>
      </div>
    </div>

    <div class="sec-label" style="margin-top:6px">–ö–æ–º–∞–Ω–¥–∞</div>
    <div class="workers-grid" id="workersGrid"></div>
  </aside>

  <!-- RESULTS -->
  <section class="panel" style="display:flex;flex-direction:column;overflow:hidden;flex:1;">

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab-btn active" id="tabChat" onclick="switchTab('chat')">üí¨ –ß–∞—Ç</button>
      <button class="tab-btn" id="tabTasks" onclick="switchTab('tasks')">üìã –ó–∞–¥–∞—á–∏</button>
    </div>

    <!-- Chat panel -->
    <div class="tab-panel active" id="panelChat" style="flex:1;overflow:hidden;flex-direction:column;">
      <div class="results" id="results">
        <div class="empty" id="emptyState">
          <div class="empty-icon">üè¢</div>
          <div class="empty-title">–ö–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</div>
          <div class="empty-sub">–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –µ—ë –ø–æ –∫–æ–º–∞–Ω–¥–µ</div>
        </div>
      </div>
    </div>

    <!-- Tasks panel -->
    <div class="tab-panel" id="panelTasks" style="flex:1;overflow:hidden;flex-direction:column;">
      <div class="tasks-list" id="tasksList">
        <div class="tasks-empty">
          <div style="font-size:32px">üìã</div>
          <div style="font-size:14px;font-weight:600">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á</div>
          <div style="font-size:12px;color:var(--dim)">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-row">
        <textarea id="taskInput" class="input-box"
          placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞–∑–±–µ—Ä—ë—Ç –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –ø–æ –∫–æ–º–∞–Ω–¥–µ‚Ä¶"
          rows="1"></textarea>
        <button class="send-btn" id="sendBtn" title="Ctrl+Enter">‚û§</button>
      </div>
      <div class="input-hint">Ctrl+Enter ¬∑ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç —Ä–∞–±–æ—Ç—É</div>
    </div>
  </section>

</div>

<script>
/* ‚îÄ‚îÄ META ‚îÄ‚îÄ */
const WORKERS = [
  { key:'researcher', name:'Researcher', emoji:'üîç', color:'#38bdf8', bg:'rgba(56,189,248,.1)',  role:'Web Researcher' },
  { key:'writer',     name:'Writer',     emoji:'‚úçÔ∏è', color:'#4ade80', bg:'rgba(74,222,128,.1)',  role:'Content Writer' },
  { key:'coder',      name:'Coder',      emoji:'üíª', color:'#facc15', bg:'rgba(250,204,21,.1)',  role:'Code Engineer'  },
  { key:'analyst',    name:'Analyst',    emoji:'üìä', color:'#fb7185', bg:'rgba(251,113,133,.1)', role:'Data Analyst'   },
];
const AGENT_META = {
  manager:    { emoji:'üéØ', color:'#a78bfa', name:'Manager'    },
  researcher: { emoji:'üîç', color:'#38bdf8', name:'Researcher' },
  writer:     { emoji:'‚úçÔ∏è', color:'#4ade80', name:'Writer'     },
  coder:      { emoji:'üíª', color:'#facc15', name:'Coder'      },
  analyst:    { emoji:'üìä', color:'#fb7185', name:'Analyst'    },
};
const BADGE_LABELS = { idle:'IDLE', thinking:'–î–£–ú–ê–ï–¢', working:'–ê–ö–¢–ò–í–ï–ù', done:'–ì–û–¢–û–í–û' };

/* Build worker cards */
document.getElementById('workersGrid').innerHTML = WORKERS.map(w => `
  <div class="a-worker idle" id="card-${w.key}">
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:6px">
      <div class="av-sm" style="background:${w.bg}">${w.emoji}</div>
      <div style="flex:1;min-width:0">
        <div class="a-name" style="font-size:11px">${w.name}</div>
        <div class="a-role" style="font-size:9px">${w.role}</div>
      </div>
      <span class="badge idle" id="badge-${w.key}">IDLE</span>
    </div>
    <div class="a-task" id="task-${w.key}">–°–≤–æ–±–æ–¥–µ–Ω</div>
    <div class="act-bar"><div class="act-fill idle" id="fill-${w.key}" style="width:0%"></div></div>
  </div>
`).join('');

/* ‚îÄ‚îÄ UPDATE CARD ‚îÄ‚îÄ */
function updateCard(a) {
  const isM  = a.key === 'manager';
  const card  = document.getElementById(`card-${a.key}`);
  const badge = document.getElementById(`badge-${a.key}`);
  const task  = document.getElementById(`task-${a.key}`);
  const fill  = document.getElementById(`fill-${a.key}`);
  if (!card) return;
  card.className  = `${isM ? 'a-manager' : 'a-worker'} ${a.status}`;
  badge.className = `badge ${a.status}`;
  badge.textContent = BADGE_LABELS[a.status] || a.status.toUpperCase();
  task.textContent  = a.task || (a.status === 'idle' ? '–°–≤–æ–±–æ–¥–µ–Ω' : '');
  task.className    = `a-task${a.status !== 'idle' ? ' on' : ''}`;
  fill.className    = `act-fill ${a.status}`;
  if (a.status === 'working' || a.status === 'done') fill.style.width = (a.progress || 50) + '%';
  else fill.style.width = '0';
}

/* ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ */
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderTable(block) {
  const rows = block.trim().split('\n').filter(r => r.trim());
  if (rows.length < 2) return esc(block);
  const isSep = r => /^[\|\s\-:]+$/.test(r);
  const parseRow = r => r.replace(/^\||\|$/g,'').split('|').map(c => c.trim());
  const headers  = parseRow(rows[0]);
  const dataRows = rows.slice(2).filter(r => !isSep(r));
  let h = '<div class="tbl-wrap"><table><thead><tr>';
  headers.forEach(c => h += `<th>${c}</th>`);
  h += '</tr></thead><tbody>';
  dataRows.forEach(row => {
    const cells = parseRow(row);
    h += '<tr>';
    cells.forEach(c => h += `<td>${c}</td>`);
    h += '</tr>';
  });
  return h + '</tbody></table></div>';
}

function md(raw) {
  // Code blocks (protect first)
  const codeBlocks = [];
  let text = raw.replace(/```[\w]*\n?([\s\S]*?)```/g, (_, code) => {
    codeBlocks.push(code.trim());
    return `\x00CODE${codeBlocks.length - 1}\x00`;
  });

  // Tables: detect blocks of lines starting with |
  text = text.replace(/((?:\|.+\n?)+)/g, block => renderTable(block));

  // Inline code
  text = text.replace(/`([^`]+)`/g, (_, c) => `<code>${esc(c)}</code>`);

  // Headings
  text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  text = text.replace(/^## (.+)$/gm,  '<h2>$1</h2>');
  text = text.replace(/^# (.+)$/gm,   '<h1>$1</h1>');

  // Bold / italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.+?)\*\*/g,     '<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g,         '<em>$1</em>');

  // HR
  text = text.replace(/^---+$/gm, '<hr>');

  // Lists
  text = text.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>[\s\S]*?<\/li>)(\n(?!<li>)|$)/g, m => `<ul>${m}</ul>`);

  // Blockquote
  text = text.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');

  // Paragraphs
  text = text.split(/\n{2,}/).map(chunk => {
    chunk = chunk.trim();
    if (!chunk) return '';
    if (/^<(h[1-3]|ul|ol|li|hr|blockquote|pre|div|table)/.test(chunk)) return chunk;
    return `<p>${chunk.replace(/\n/g,'<br>')}</p>`;
  }).join('\n');

  // Restore code blocks
  text = text.replace(/\x00CODE(\d+)\x00/g, (_, i) =>
    `<pre><code>${esc(codeBlocks[parseInt(i)])}</code></pre>`);

  return text;
}

/* ‚îÄ‚îÄ MESSAGE DEDUPLICATION ‚îÄ‚îÄ */
const seenKeys = new Set();
function msgKey(msg) {
  return `${msg.role}|${(msg.content || '').slice(0, 80)}`;
}

/* ‚îÄ‚îÄ ADD MESSAGE ‚îÄ‚îÄ */
let cardCount = 0;

function addMessage(msg, fromHistory) {
  const key = msgKey(msg);
  if (seenKeys.has(key)) return;
  seenKeys.add(key);

  const empty = document.getElementById('emptyState');
  if (empty) empty.remove();

  const wrap   = document.getElementById('results');
  const role   = msg.role;
  const meta   = AGENT_META[role] || { emoji:'ü§ñ', color:'#888', name: msg.name || role };
  const color  = msg.color || meta.color;
  const emoji  = msg.emoji || meta.emoji;

  /* User bubble */
  if (role === 'user') {
    const el = document.createElement('div');
    el.className = 'user-wrap';
    el.innerHTML = `<div class="user-meta">${msg.time}</div>
      <div class="user-msg">${esc(msg.content)}</div>`;
    wrap.appendChild(el);
    if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
    return;
  }

  /* Manager plan bar */
  const isPlan = /^\*\*Plan:\*\*|^Plan:/i.test(msg.content.trim());
  if (role === 'manager' && isPlan) {
    const el = document.createElement('div');
    el.className = 'plan-bar';
    el.innerHTML = `<span class="plan-badge">üéØ Manager</span>
      <span class="plan-text">${esc(msg.content.replace(/^\*\*Plan:\*\*\s*/,'').replace(/^Plan:\s*/i,''))}</span>
      <span class="plan-time">${msg.time}</span>`;
    wrap.appendChild(el);
    if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
    return;
  }

  /* Agent result card */
  const id      = 'rc' + (++cardCount);
  const preview = (msg.content || '').replace(/[#*`|]/g,' ').replace(/\s+/g,' ').trim().slice(0, 100);

  const el = document.createElement('div');
  el.className = 'result-card open';
  el.style.setProperty('--accent', color);
  el.style.borderColor = color + '28';
  el.innerHTML = `
    <div class="rc-header" onclick="toggleCard('${id}',this.parentElement)">
      <div class="rc-av" style="background:${color}18">${emoji}</div>
      <span class="rc-name" style="color:${color}">${esc(msg.name || meta.name)}</span>
      <span class="rc-preview">${esc(preview)}${msg.content.length > 100 ? '‚Ä¶' : ''}</span>
      <span class="rc-time">${msg.time}</span>
      <span class="rc-arrow">‚ñæ</span>
    </div>
    <div class="rc-body" id="${id}">
      <div class="rc-scroll">
        <div class="md">${md(msg.content)}</div>
      </div>
    </div>`;

  // Collapse previously open cards
  wrap.querySelectorAll('.result-card.open').forEach(c => c.classList.remove('open'));

  wrap.appendChild(el);
  if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
}

function toggleCard(id, card) {
  card.classList.toggle('open');
}

/* ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ */
let ws;
function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  const liveEl = document.getElementById('liveEl');
  ws.onopen  = () => { liveEl.textContent = 'LIVE';    liveEl.className = 'live'; };
  ws.onclose = () => { liveEl.textContent = 'OFFLINE'; liveEl.className = 'live off'; setTimeout(connect, 3000); };
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'init') {
      data.agents.forEach(updateCard);
      data.history.forEach(m => addMessage(m, true));
      const wrap = document.getElementById('results');
      wrap.scrollTop = wrap.scrollHeight;
    } else if (data.type === 'agents') {
      data.agents.forEach(updateCard);
    } else if (data.type === 'chat') {
      addMessage(data.message, false);
    } else if (data.type === 'tasks_update') {
      if (document.getElementById('panelTasks').classList.contains('active')) {
        loadTasks();
      }
    }
  };
}

/* ‚îÄ‚îÄ SEND ‚îÄ‚îÄ */
function sendTask() {
  const input = document.getElementById('taskInput');
  const text  = input.value.trim();
  if (!text || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type: 'task', content: text }));
  input.value = '';
  input.style.height = 'auto';
}

document.getElementById('sendBtn').addEventListener('click', sendTask);
document.getElementById('taskInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendTask(); }
  setTimeout(() => {
    const el = e.target;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  });
});

/* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
(function tick() {
  const n = new Date();
  document.getElementById('clockEl').textContent =
    [n.getHours(), n.getMinutes(), n.getSeconds()].map(v => String(v).padStart(2,'0')).join(':');
  setTimeout(tick, 1000);
})();

connect();

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function switchTab(tab) {
  document.getElementById('tabChat').classList.toggle('active', tab === 'chat');
  document.getElementById('tabTasks').classList.toggle('active', tab === 'tasks');
  document.getElementById('panelChat').classList.toggle('active', tab === 'chat');
  document.getElementById('panelTasks').classList.toggle('active', tab === 'tasks');
  if (tab === 'tasks') loadTasks();
}

/* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
async function loadTasks() {
  try {
    const r = await fetch('/api/tasks');
    const data = await r.json();
    renderTasks(data.tasks || []);
  } catch (e) {
    console.error('loadTasks error', e);
  }
}

function renderTasks(tasks) {
  const el = document.getElementById('tasksList');
  if (!tasks.length) return; // keep placeholder

  el.innerHTML = tasks.map(t => {
    const date = new Date(t.created_at);
    const dateStr = date.toLocaleDateString('ru-RU', { day:'numeric', month:'short' })
      + ' ' + date.toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });
    const status = t.status || 'processing';
    const statusLabel = status === 'done' ? '–ì–æ—Ç–æ–≤–æ' : status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' : '–û–∂–∏–¥–∞–Ω–∏–µ';
    const summary = t.summary ? `<div class="task-summary">${esc(t.summary)}</div>` : '';
    return `<div class="task-row">
      <div class="task-row-left">
        <div class="task-content">${esc(t.content)}</div>
        <div class="task-meta">${dateStr}</div>
        ${summary}
      </div>
      <span class="task-status ${status}">${statusLabel}</span>
    </div>`;
  }).join('');
}

</script>
</body>
</html>
