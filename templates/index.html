<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Office</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:      #000;
  --s1:      rgba(255,255,255,.04);
  --s2:      rgba(255,255,255,.07);
  --s3:      rgba(255,255,255,.11);
  --bdr:     rgba(255,255,255,.07);
  --bdr2:    rgba(255,255,255,.12);
  --t1:      rgba(255,255,255,.95);
  --t2:      rgba(255,255,255,.55);
  --t3:      rgba(255,255,255,.28);
  --accent:  #6d5bfa;
  --acc-low: rgba(109,91,250,.18);
  --acc-glo: rgba(109,91,250,.12);
  --radius:  16px;
  --sans:    -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
}

html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg); color: var(--t1);
  font-family: var(--sans);
  -webkit-font-smoothing: antialiased;
  display: flex; flex-direction: column;
}

/* ‚îÄ‚îÄ NOISE TEXTURE ‚îÄ‚îÄ */
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none;
  opacity: .018;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 200px 200px;
}

/* ‚îÄ‚îÄ AMBIENT GLOW ‚îÄ‚îÄ */
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 55% 35% at 12% 8%,  rgba(109,91,250,.08) 0%, transparent 70%),
    radial-gradient(ellipse 40% 30% at 88% 92%,  rgba(56,189,248,.05) 0%, transparent 70%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  height: 52px; flex-shrink: 0;
  display: flex; align-items: center; padding: 0 22px;
  justify-content: space-between;
  border-bottom: 1px solid var(--bdr);
  background: rgba(0,0,0,.72);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  position: relative; z-index: 20;
}
.logo {
  font-size: 14px; font-weight: 600; letter-spacing: -.3px; color: var(--t1);
  display: flex; align-items: center; gap: 8px;
}
.logo-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: linear-gradient(135deg, #a78bfa, #6d5bfa);
  box-shadow: 0 0 10px rgba(109,91,250,.6);
}
.hdr-right { display: flex; align-items: center; gap: 16px; }
.live-pill {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 10px; border-radius: 99px;
  background: rgba(74,222,128,.08);
  border: 1px solid rgba(74,222,128,.15);
  font-size: 11px; font-weight: 600; color: #4ade80; letter-spacing: .3px;
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%; background: #4ade80;
  animation: pulse 2s infinite;
}
.live-pill.off { background: rgba(248,113,113,.08); border-color: rgba(248,113,113,.15); color: #f87171; }
.live-pill.off .live-dot { background: #f87171; animation: none; }
@keyframes pulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(74,222,128,.4); }
  50%      { box-shadow: 0 0 0 5px rgba(74,222,128,.0); }
}
.clock { font-size: 13px; color: var(--t3); font-variant-numeric: tabular-nums; letter-spacing: -.2px; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 1; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: 232px; flex-shrink: 0;
  border-right: 1px solid var(--bdr);
  padding: 14px 10px;
  overflow-y: auto; overflow-x: hidden;
  display: flex; flex-direction: column; gap: 6px;
  background: rgba(0,0,0,.3);
}
.sidebar-label {
  font-size: 10px; font-weight: 600; color: var(--t3);
  letter-spacing: 1px; text-transform: uppercase;
  padding: 2px 6px; margin-top: 2px;
}

/* Manager card */
.mgr-card {
  background: var(--s1);
  border: 1px solid var(--bdr);
  border-radius: var(--radius);
  padding: 13px 14px;
  display: flex; align-items: center; gap: 12px;
  transition: background .3s, border-color .3s, box-shadow .3s;
}
.mgr-card.working, .mgr-card.thinking {
  background: var(--acc-glo);
  border-color: rgba(109,91,250,.25);
  box-shadow: 0 0 24px rgba(109,91,250,.08);
}

/* Worker cards grid */
.workers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.wkr-card {
  background: var(--s1);
  border: 1px solid var(--bdr);
  border-radius: 13px;
  padding: 11px 11px 9px;
  transition: background .3s, border-color .3s;
}
.wkr-card.working { background: rgba(255,255,255,.055); border-color: var(--bdr2); }
.wkr-card.done    { border-color: rgba(74,222,128,.2); }

/* Avatar */
.av {
  width: 38px; height: 38px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; flex-shrink: 0;
  transition: box-shadow .3s;
}
.av-sm {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; flex-shrink: 0;
}

/* Status badge */
.badge {
  display: inline-flex; align-items: center;
  font-size: 9px; font-weight: 700; letter-spacing: .5px;
  text-transform: uppercase; padding: 2px 7px; border-radius: 99px;
  white-space: nowrap;
}
.badge.idle     { background: rgba(255,255,255,.06);  color: var(--t3); }
.badge.thinking { background: rgba(109,91,250,.2);    color: #a78bfa; animation: flicker .8s infinite; }
.badge.working  { background: rgba(74,222,128,.15);   color: #4ade80; }
.badge.done     { background: rgba(74,222,128,.18);   color: #4ade80; }
@keyframes flicker { 0%,100%{opacity:1} 50%{opacity:.35} }

.ag-info { flex: 1; min-width: 0; }
.ag-name { font-size: 13px; font-weight: 600; color: var(--t1); letter-spacing: -.2px; }
.ag-role { font-size: 10px; color: var(--t3); margin-top: 1px; }
.ag-task {
  font-size: 10px; color: var(--t3); margin-top: 6px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color .3s;
}
.ag-task.on { color: var(--t2); }

/* Activity bar */
.act-bar { height: 2px; background: rgba(255,255,255,.05); border-radius: 1px; margin-top: 8px; overflow: hidden; }
.act-fill { height: 100%; border-radius: 1px; transition: width .6s, background .4s; width: 0; }
.act-fill.idle     { background: transparent; }
.act-fill.thinking { background: #a78bfa; animation: sweep 1.5s ease-in-out infinite; }
.act-fill.working  { background: #4ade80; }
.act-fill.done     { background: #4ade80; width: 100% !important; }
@keyframes sweep {
  0%   { transform: translateX(-100%); width: 55%; }
  100% { transform: translateX(210%);  width: 55%; }
}

/* ‚îÄ‚îÄ MAIN PANEL ‚îÄ‚îÄ */
.main-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* Tab bar */
.tab-bar {
  display: flex; align-items: center; gap: 1px;
  padding: 10px 18px 0; flex-shrink: 0;
  border-bottom: 1px solid var(--bdr);
}
.tab-btn {
  font-size: 12px; font-weight: 500; color: var(--t3);
  padding: 7px 14px; border-radius: 10px 10px 0 0;
  border: none; background: none; cursor: pointer;
  border-bottom: 1.5px solid transparent; margin-bottom: -1px;
  transition: color .15s;
}
.tab-btn:hover { color: var(--t2); }
.tab-btn.active { color: var(--t1); border-bottom-color: var(--accent); }

/* Tab panels */
.tab-panel { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.tab-panel.active { display: flex; }

/* Results feed */
.results {
  flex: 1; overflow-y: auto;
  padding: 16px 18px 10px;
  display: flex; flex-direction: column; gap: 10px;
}

/* Empty state */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px; opacity: .25; pointer-events: none; text-align: center;
}
.empty-icon { font-size: 42px; }
.empty-t1   { font-size: 15px; font-weight: 600; letter-spacing: -.3px; }
.empty-t2   { font-size: 12px; color: var(--t2); line-height: 1.6; max-width: 240px; }

/* ‚îÄ‚îÄ USER BUBBLE ‚îÄ‚îÄ */
.user-wrap { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.user-time { font-size: 10px; color: var(--t3); padding-right: 2px; }
.user-bubble {
  max-width: 66%;
  background: linear-gradient(145deg, #4f46e5, #7c3aed);
  color: rgba(255,255,255,.92); border-radius: 18px 18px 4px 18px;
  padding: 10px 14px; font-size: 14px; line-height: 1.55;
  letter-spacing: -.1px;
  box-shadow: 0 4px 24px rgba(79,70,229,.25);
}

/* ‚îÄ‚îÄ PLAN BAR ‚îÄ‚îÄ */
.plan-bar {
  display: flex; align-items: flex-start; gap: 10px;
  background: rgba(109,91,250,.06); border: 1px solid rgba(109,91,250,.12);
  border-radius: 11px; padding: 9px 13px;
  font-size: 12px; color: var(--t2); line-height: 1.55;
}
.plan-who { color: #a78bfa; font-weight: 600; flex-shrink: 0; font-size: 11.5px; }
.plan-body { flex: 1; }
.plan-ts   { flex-shrink: 0; font-size: 10px; color: var(--t3); padding-top: 1px; }

/* ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ */
.result-card {
  background: var(--s1);
  border: 1px solid var(--bdr);
  border-radius: var(--radius);
  overflow: hidden;
  animation: cardIn .3s cubic-bezier(.25,.46,.45,.94) both;
  transition: border-color .25s, background .25s;
}
.result-card:hover { background: var(--s2); }
@keyframes cardIn {
  from { opacity: 0; transform: translateY(8px) scale(.99); }
  to   { opacity: 1; transform: none; }
}

.rc-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; cursor: pointer; user-select: none;
  transition: background .15s;
  border-radius: var(--radius) var(--radius) 0 0;
}
.rc-header:hover { background: rgba(255,255,255,.025); }

.rc-av {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; flex-shrink: 0;
}
.rc-name    { font-size: 12px; font-weight: 700; flex-shrink: 0; letter-spacing: -.1px; }
.rc-preview {
  flex: 1; font-size: 12px; color: var(--t2);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
}
.rc-time    { font-size: 10px; color: var(--t3); flex-shrink: 0; font-variant-numeric: tabular-nums; }
.rc-arrow   {
  font-size: 10px; color: var(--t3); flex-shrink: 0; margin-left: 4px;
  transition: transform .22s cubic-bezier(.25,.46,.45,.94);
}
.result-card.open .rc-arrow { transform: rotate(180deg); }

/* Card body ‚Äî scrollable */
.rc-body { display: none; padding: 0 14px 14px; }
.result-card.open .rc-body { display: block; }
.rc-scroll {
  max-height: 520px; overflow-y: auto; padding-right: 4px;
  border-top: 1px solid var(--bdr); padding-top: 13px;
}
.rc-scroll::-webkit-scrollbar { width: 3px; }
.rc-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

/* ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ */
.md { font-size: 13.5px; line-height: 1.75; color: rgba(255,255,255,.82); letter-spacing: -.1px; }
.md strong { font-weight: 600; color: var(--t1); }
.md em     { color: var(--t2); font-style: italic; }
.md h1 { font-size: 18px; font-weight: 700; color: var(--t1); margin: 16px 0 8px; letter-spacing: -.5px; }
.md h2 { font-size: 15px; font-weight: 600; color: var(--t1); margin: 14px 0 7px; letter-spacing: -.3px; }
.md h3 { font-size: 13.5px; font-weight: 600; color: var(--t1); margin: 12px 0 6px; }
.md p  { margin-bottom: 10px; }
.md ul,.md ol { padding-left: 20px; margin-bottom: 10px; }
.md li { margin-bottom: 5px; }
.md code {
  background: rgba(255,255,255,.08); padding: 2px 7px; border-radius: 5px;
  font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace; font-size: 12px;
  color: #c4b5fd;
}
.md pre {
  background: rgba(255,255,255,.04); border: 1px solid var(--bdr);
  border-radius: 11px; padding: 13px 15px; margin: 10px 0; overflow-x: auto;
}
.md pre code { background: none; padding: 0; font-size: 12px; color: rgba(255,255,255,.75); }
.md blockquote {
  border-left: 2px solid rgba(109,91,250,.4);
  padding-left: 14px; color: var(--t2); margin: 10px 0; font-style: italic;
}
.md hr { border: none; border-top: 1px solid var(--bdr); margin: 14px 0; }

/* Tables */
.md .tbl-wrap { overflow-x: auto; margin: 10px 0; border-radius: 10px; border: 1px solid var(--bdr); }
.md table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
.md th, .md td { padding: 8px 13px; border-bottom: 1px solid var(--bdr); text-align: left; }
.md th { background: rgba(255,255,255,.04); font-weight: 600; color: var(--t1); border-bottom-color: var(--bdr2); }
.md tr:last-child td { border-bottom: none; }
.md tr:hover td { background: rgba(255,255,255,.02); }

/* ‚îÄ‚îÄ TASKS PANEL ‚îÄ‚îÄ */
.tasks-list {
  flex: 1; overflow-y: auto; padding: 16px 18px;
  display: flex; flex-direction: column; gap: 8px;
}
.task-item {
  background: var(--s1); border: 1px solid var(--bdr);
  border-radius: 13px; padding: 12px 15px;
  display: flex; align-items: flex-start; gap: 13px;
  transition: background .2s, border-color .2s;
}
.task-item:hover { background: var(--s2); }
.task-left { flex: 1; min-width: 0; }
.task-content {
  font-size: 13.5px; font-weight: 500; color: var(--t1);
  letter-spacing: -.2px; line-height: 1.45;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.task-meta { font-size: 10px; color: var(--t3); margin-top: 4px; }
.task-summary { font-size: 12px; color: var(--t2); margin-top: 5px; line-height: 1.5; }
.task-badge {
  font-size: 10px; font-weight: 600; padding: 3px 9px;
  border-radius: 99px; letter-spacing: .2px; white-space: nowrap; flex-shrink: 0; margin-top: 1px;
}
.task-badge.processing { background: rgba(109,91,250,.18); color: #a78bfa; }
.task-badge.done       { background: rgba(74,222,128,.12);  color: #4ade80; }
.task-badge.pending    { background: rgba(251,191,36,.1);   color: #fbbf24; }
.tasks-empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px; opacity: .22; text-align: center;
}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-area {
  flex-shrink: 0;
  padding: 12px 18px 16px;
  border-top: 1px solid var(--bdr);
  background: rgba(0,0,0,.5);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.input-shell {
  display: flex; align-items: flex-end; gap: 10px;
  background: var(--s2);
  border: 1px solid var(--bdr);
  border-radius: 14px; padding: 10px 10px 10px 16px;
  transition: border-color .2s, box-shadow .2s;
}
.input-shell:focus-within {
  border-color: rgba(109,91,250,.35);
  box-shadow: 0 0 0 3px rgba(109,91,250,.1);
}
.input-box {
  flex: 1; background: none; border: none; outline: none;
  color: var(--t1); font-family: var(--sans); font-size: 14px;
  resize: none; min-height: 24px; max-height: 110px; line-height: 1.5;
  letter-spacing: -.1px;
}
.input-box::placeholder { color: var(--t3); }
.send-btn {
  width: 34px; height: 34px; border-radius: 10px; flex-shrink: 0;
  background: var(--accent); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 14px;
  transition: background .15s, transform .1s, opacity .15s;
}
.send-btn:hover  { background: #5b4ce8; }
.send-btn:active { transform: scale(.9); }
.input-hint { font-size: 10px; color: var(--t3); margin-top: 7px; text-align: center; }

/* scrollbars */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.08); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    Agent Office
  </div>
  <div class="hdr-right">
    <div class="live-pill" id="liveEl">
      <div class="live-dot"></div>
      LIVE
    </div>
    <div class="clock" id="clockEl">00:00:00</div>
  </div>
</header>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</div>

    <div class="mgr-card idle" id="card-manager">
      <div class="av" style="background:rgba(167,139,250,.12)" id="av-manager">üéØ</div>
      <div class="ag-info">
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:2px">
          <span class="ag-name">Manager</span>
          <span class="badge idle" id="badge-manager">IDLE</span>
        </div>
        <div class="ag-role">Orchestrator</div>
        <div class="ag-task" id="task-manager">–û–∂–∏–¥–∞–µ—Ç –∑–∞–¥–∞—á—É</div>
        <div class="act-bar"><div class="act-fill idle" id="fill-manager"></div></div>
      </div>
    </div>

    <div class="sidebar-label" style="margin-top:8px">–ö–æ–º–∞–Ω–¥–∞</div>
    <div class="workers-grid" id="workersGrid"></div>
  </aside>

  <!-- MAIN -->
  <section class="main-panel">

    <div class="tab-bar">
      <button class="tab-btn active" id="tabChat"  onclick="switchTab('chat')">–ß–∞—Ç</button>
      <button class="tab-btn"        id="tabTasks" onclick="switchTab('tasks')">–ó–∞–¥–∞—á–∏</button>
    </div>

    <!-- Chat tab -->
    <div class="tab-panel active" id="panelChat">
      <div class="results" id="results">
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">‚ú¶</div>
          <div class="empty-t1">–ö–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞</div>
          <div class="empty-t2">–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –µ—ë –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏</div>
        </div>
      </div>
    </div>

    <!-- Tasks tab -->
    <div class="tab-panel" id="panelTasks">
      <div class="tasks-list" id="tasksList">
        <div class="tasks-empty">
          <div style="font-size:30px;margin-bottom:4px">‚ó´</div>
          <div style="font-size:14px;font-weight:600;letter-spacing:-.3px">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á</div>
          <div style="font-size:12px;color:var(--t2)">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤–∞—à–∏ –∑–∞–¥–∞—á–∏</div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-shell">
        <textarea id="taskInput" class="input-box"
          placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É‚Ä¶" rows="1"></textarea>
        <button class="send-btn" id="sendBtn" title="Ctrl+Enter">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="input-hint">Ctrl+Enter ¬∑ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç —Ä–∞–±–æ—Ç—É –ø–æ –∫–æ–º–∞–Ω–¥–µ</div>
    </div>

  </section>
</div>

<script>
/* ‚îÄ‚îÄ AGENT META ‚îÄ‚îÄ */
const WORKERS = [
  { key:'researcher', name:'Researcher', emoji:'üîç', color:'#38bdf8', bg:'rgba(56,189,248,.1)',  role:'Web Researcher' },
  { key:'writer',     name:'Writer',     emoji:'‚úçÔ∏è', color:'#4ade80', bg:'rgba(74,222,128,.1)',  role:'Content Writer' },
  { key:'coder',      name:'Coder',      emoji:'üíª', color:'#facc15', bg:'rgba(250,204,21,.1)',  role:'Code Engineer'  },
  { key:'analyst',    name:'Analyst',    emoji:'üìä', color:'#fb7185', bg:'rgba(251,113,133,.1)', role:'Data Analyst'   },
];
const AGENT_META = {
  manager:    { emoji:'üéØ', color:'#a78bfa', name:'Manager'    },
  researcher: { emoji:'üîç', color:'#38bdf8', name:'Researcher' },
  writer:     { emoji:'‚úçÔ∏è', color:'#4ade80', name:'Writer'     },
  coder:      { emoji:'üíª', color:'#facc15', name:'Coder'      },
  analyst:    { emoji:'üìä', color:'#fb7185', name:'Analyst'    },
};
const BADGE_LBL = { idle:'IDLE', thinking:'–î–£–ú–ê–ï–¢', working:'–ê–ö–¢–ò–í–ï–ù', done:'–ì–û–¢–û–í–û' };

/* Build worker cards */
document.getElementById('workersGrid').innerHTML = WORKERS.map(w => `
  <div class="wkr-card idle" id="card-${w.key}">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:7px">
      <div class="av-sm" style="background:${w.bg}">${w.emoji}</div>
      <div style="flex:1;min-width:0">
        <div class="ag-name" style="font-size:11.5px">${w.name}</div>
        <div class="ag-role" style="font-size:9.5px">${w.role}</div>
      </div>
      <span class="badge idle" id="badge-${w.key}">IDLE</span>
    </div>
    <div class="ag-task" id="task-${w.key}">–°–≤–æ–±–æ–¥–µ–Ω</div>
    <div class="act-bar"><div class="act-fill idle" id="fill-${w.key}"></div></div>
  </div>
`).join('');

/* ‚îÄ‚îÄ UPDATE AGENT CARD ‚îÄ‚îÄ */
function updateCard(a) {
  const isM  = a.key === 'manager';
  const card  = document.getElementById(`card-${a.key}`);
  const badge = document.getElementById(`badge-${a.key}`);
  const task  = document.getElementById(`task-${a.key}`);
  const fill  = document.getElementById(`fill-${a.key}`);
  if (!card) return;
  card.className  = (isM ? 'mgr-card' : 'wkr-card') + ' ' + a.status;
  badge.className = 'badge ' + a.status;
  badge.textContent = BADGE_LBL[a.status] || a.status.toUpperCase();
  task.textContent  = (a.task && a.task !== '–°–≤–æ–±–æ–¥–µ–Ω') ? a.task : (a.status === 'idle' ? '–°–≤–æ–±–æ–¥–µ–Ω' : '');
  task.className    = 'ag-task' + (a.status !== 'idle' ? ' on' : '');
  fill.className    = 'act-fill ' + a.status;
  fill.style.width  = (a.status === 'working' || a.status === 'done') ? (a.progress || 50) + '%' : '';
}

/* ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ */
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderTable(block) {
  const rows = block.trim().split('\n').filter(r => r.trim());
  if (rows.length < 2) return esc(block);
  const isSep  = r => /^[\|\s\-:]+$/.test(r);
  const parseR = r => r.replace(/^\||\|$/g,'').split('|').map(c => c.trim());
  const heads  = parseR(rows[0]);
  const bodies = rows.slice(2).filter(r => !isSep(r));
  let h = '<div class="tbl-wrap"><table><thead><tr>';
  heads.forEach(c  => h += `<th>${c}</th>`);
  h += '</tr></thead><tbody>';
  bodies.forEach(r => {
    h += '<tr>';
    parseR(r).forEach(c => h += `<td>${c}</td>`);
    h += '</tr>';
  });
  return h + '</tbody></table></div>';
}

function md(raw) {
  const codes = [];
  let t = raw.replace(/```[\w]*\n?([\s\S]*?)```/g, (_, c) => {
    codes.push(c.trim()); return `\x00C${codes.length-1}\x00`;
  });
  t = t.replace(/((?:\|.+\n?)+)/g, b => renderTable(b));
  t = t.replace(/`([^`]+)`/g, (_, c) => `<code>${esc(c)}</code>`);
  t = t.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  t = t.replace(/^## (.+)$/gm,  '<h2>$1</h2>');
  t = t.replace(/^# (.+)$/gm,   '<h1>$1</h1>');
  t = t.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  t = t.replace(/\*\*(.+?)\*\*/g,     '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g,         '<em>$1</em>');
  t = t.replace(/^---+$/gm, '<hr>');
  t = t.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
  t = t.replace(/(<li>[\s\S]*?<\/li>)(\n(?!<li>)|$)/g, m => `<ul>${m}</ul>`);
  t = t.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
  t = t.split(/\n{2,}/).map(chunk => {
    chunk = chunk.trim();
    if (!chunk) return '';
    if (/^<(h[1-3]|ul|ol|hr|blockquote|pre|div|table)/.test(chunk)) return chunk;
    return `<p>${chunk.replace(/\n/g,'<br>')}</p>`;
  }).join('\n');
  t = t.replace(/\x00C(\d+)\x00/g, (_, i) =>
    `<pre><code>${esc(codes[+i])}</code></pre>`);
  return t;
}

/* ‚îÄ‚îÄ DEDUP ‚îÄ‚îÄ */
const seen = new Set();
function msgKey(m) { return `${m.role}|${(m.content||'').slice(0,80)}`; }

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
let cardN = 0;

function addMessage(msg, fromHistory) {
  const k = msgKey(msg);
  if (seen.has(k)) return;
  seen.add(k);

  const empty = document.getElementById('emptyState');
  if (empty) empty.remove();

  const wrap  = document.getElementById('results');
  const role  = msg.role;
  const meta  = AGENT_META[role] || { emoji:'ü§ñ', color:'#888', name: msg.name || role };
  const color = msg.color || meta.color;
  const emoji = msg.emoji || meta.emoji;

  /* User */
  if (role === 'user') {
    const el = document.createElement('div');
    el.className = 'user-wrap';
    el.innerHTML = `<div class="user-time">${msg.time}</div>
      <div class="user-bubble">${esc(msg.content)}</div>`;
    wrap.appendChild(el);
    if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
    return;
  }

  /* Plan bar */
  const isPlan = /^\*\*Plan:\*\*|^Plan:/i.test(msg.content.trim());
  if (role === 'manager' && isPlan) {
    const txt = msg.content.replace(/^\*\*Plan:\*\*\s*/,'').replace(/^Plan:\s*/i,'');
    const el = document.createElement('div');
    el.className = 'plan-bar';
    el.innerHTML = `<span class="plan-who">üéØ Manager</span>
      <span class="plan-body">${esc(txt)}</span>
      <span class="plan-ts">${msg.time}</span>`;
    wrap.appendChild(el);
    if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
    return;
  }

  /* Agent result card */
  const id      = 'rc' + (++cardN);
  const preview = (msg.content||'').replace(/[#*`|\n]/g,' ').replace(/\s+/g,' ').trim().slice(0,100);

  const el = document.createElement('div');
  el.className = 'result-card open';
  el.style.borderColor = color + '22';
  el.innerHTML = `
    <div class="rc-header" onclick="toggleCard('${id}',this.parentElement)"
         style="background:linear-gradient(90deg,${color}09 0%,transparent 60%)">
      <div class="rc-av" style="background:${color}18">${emoji}</div>
      <span class="rc-name" style="color:${color}">${esc(msg.name || meta.name)}</span>
      <span class="rc-preview">${esc(preview)}${msg.content.length > 100 ? '‚Ä¶' : ''}</span>
      <span class="rc-time">${msg.time}</span>
      <span class="rc-arrow">‚ñæ</span>
    </div>
    <div class="rc-body" id="${id}">
      <div class="rc-scroll"><div class="md">${md(msg.content)}</div></div>
    </div>`;

  wrap.querySelectorAll('.result-card.open').forEach(c => c.classList.remove('open'));
  wrap.appendChild(el);
  if (!fromHistory) wrap.scrollTop = wrap.scrollHeight;
}

function toggleCard(id, card) { card.classList.toggle('open'); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function switchTab(tab) {
  ['chat','tasks'].forEach(t => {
    document.getElementById('tab'  + t[0].toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
    document.getElementById('panel'+ t[0].toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
  });
  if (tab === 'tasks') loadTasks();
}

/* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
async function loadTasks() {
  try {
    const r = await fetch('/api/tasks');
    const d = await r.json();
    renderTasks(d.tasks || []);
  } catch(e) {}
}

function renderTasks(tasks) {
  const el = document.getElementById('tasksList');
  if (!tasks.length) return;
  el.innerHTML = tasks.map(t => {
    const date = new Date(t.created_at);
    const ds = date.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})
             + ' ¬∑ ' + date.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    const st = t.status || 'processing';
    const sl = st === 'done' ? '–ì–æ—Ç–æ–≤–æ' : st === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' : '–û–∂–∏–¥–∞–Ω–∏–µ';
    const sum = t.summary ? `<div class="task-summary">${esc(t.summary)}</div>` : '';
    return `<div class="task-item">
      <div class="task-left">
        <div class="task-content">${esc(t.content)}</div>
        <div class="task-meta">${ds}</div>${sum}
      </div>
      <span class="task-badge ${st}">${sl}</span>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ */
let ws;
function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  const liveEl = document.getElementById('liveEl');

  ws.onopen = () => {
    liveEl.className = 'live-pill';
    liveEl.innerHTML = '<div class="live-dot"></div>LIVE';
  };
  ws.onclose = () => {
    liveEl.className = 'live-pill off';
    liveEl.innerHTML = '<div class="live-dot"></div>OFFLINE';
    setTimeout(connect, 3000);
  };
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'init') {
      data.agents.forEach(updateCard);
      data.history.forEach(m => addMessage(m, true));
      const w = document.getElementById('results');
      w.scrollTop = w.scrollHeight;
    } else if (data.type === 'agents') {
      data.agents.forEach(updateCard);
    } else if (data.type === 'chat') {
      addMessage(data.message, false);
    } else if (data.type === 'tasks_update') {
      if (document.getElementById('panelTasks').classList.contains('active')) loadTasks();
    }
  };
}

/* ‚îÄ‚îÄ SEND ‚îÄ‚îÄ */
function sendTask() {
  const inp = document.getElementById('taskInput');
  const txt = inp.value.trim();
  if (!txt || !ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type:'task', content:txt }));
  inp.value = '';
  inp.style.height = 'auto';
}

document.getElementById('sendBtn').addEventListener('click', sendTask);
document.getElementById('taskInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); sendTask(); }
  setTimeout(() => {
    const el = e.target;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 110) + 'px';
  });
});

/* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
(function tick() {
  const n = new Date();
  document.getElementById('clockEl').textContent =
    [n.getHours(),n.getMinutes(),n.getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');
  setTimeout(tick, 1000);
})();

connect();
</script>
</body>
</html>
