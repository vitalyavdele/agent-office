<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Office</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:    #111113;
  --bg2:   #18181b;
  --bg3:   #222226;
  --bdr:   rgba(255,255,255,.07);
  --bdr2:  rgba(255,255,255,.13);
  --t1:    rgba(255,255,255,.92);
  --t2:    rgba(255,255,255,.50);
  --t3:    rgba(255,255,255,.26);
  --acc:   #7c6af5;
  --sans:  -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
}

html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg); color: var(--t1);
  font-family: var(--sans); font-size: 14px;
  -webkit-font-smoothing: antialiased;
  display: flex; flex-direction: column;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  height: 48px; flex-shrink: 0;
  display: flex; align-items: center; padding: 0 18px;
  justify-content: space-between;
  background: rgba(17,17,19,.9);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--bdr);
  position: relative; z-index: 20;
}
.logo {
  display: flex; align-items: center; gap: 9px;
  font-size: 14px; font-weight: 600; letter-spacing: -.3px; color: var(--t1);
}
.logo-mark {
  width: 22px; height: 22px; border-radius: 7px;
  background: linear-gradient(135deg, #6d5bfa, #a78bfa);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; box-shadow: 0 2px 12px rgba(109,91,250,.35);
}
.hdr-right { display: flex; align-items: center; gap: 14px; }
.live-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 3px 10px 3px 8px; border-radius: 99px;
  font-size: 11px; font-weight: 600; letter-spacing: .2px;
  background: rgba(74,222,128,.1); border: 1px solid rgba(74,222,128,.18); color: #4ade80;
  transition: all .3s;
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: glow 2s infinite; }
@keyframes glow { 0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,.5)} 50%{box-shadow:0 0 0 4px rgba(74,222,128,0)} }
.live-badge.off { background: rgba(248,113,113,.08); border-color: rgba(248,113,113,.18); color: #f87171; }
.live-badge.off .live-dot { animation: none; }
.clock { font-size: 13px; color: var(--t3); font-variant-numeric: tabular-nums; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout { flex: 1; display: flex; overflow: hidden; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width: 220px; flex-shrink: 0;
  background: var(--bg);
  border-right: 1px solid var(--bdr);
  overflow-y: auto; overflow-x: hidden;
  padding: 12px 8px;
  display: flex; flex-direction: column; gap: 4px;
}
.sl { /* section label */
  font-size: 10px; font-weight: 600; color: var(--t3);
  letter-spacing: .9px; text-transform: uppercase;
  padding: 10px 8px 5px;
}
.sl:first-child { padding-top: 2px; }

/* Manager card */
.mgr {
  display: flex; align-items: center; gap: 10px;
  background: var(--bg2); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 10px 12px;
  transition: border-color .3s, background .3s;
}
.mgr.working, .mgr.thinking {
  background: rgba(109,91,250,.07);
  border-color: rgba(109,91,250,.22);
}

/* Agent row (workers) */
.ag-row {
  display: flex; align-items: center; gap: 9px;
  padding: 8px 10px; border-radius: 9px;
  background: transparent;
  transition: background .15s;
}
.ag-row:hover { background: var(--bg2); }
.ag-row.working, .ag-row.thinking { background: var(--bg2); }

/* Avatars */
.av40 { width: 36px; height: 36px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
.av28 { width: 28px; height: 28px; border-radius: 9px;  display:flex; align-items:center; justify-content:center; font-size:13px; flex-shrink:0; }

/* Status badge */
.badge {
  font-size: 9px; font-weight: 700; letter-spacing: .5px;
  text-transform: uppercase; padding: 2px 7px; border-radius: 99px; white-space: nowrap;
}
.badge.idle     { background: rgba(255,255,255,.06); color: var(--t3); }
.badge.thinking { background: rgba(167,139,250,.18); color: #c4b5fd; animation: blink .85s infinite; }
.badge.working  { background: rgba(74,222,128,.14);  color: #4ade80; }
.badge.done     { background: rgba(74,222,128,.14);  color: #4ade80; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

.ag-info { flex: 1; min-width: 0; }
.ag-name { font-size: 13px; font-weight: 600; color: var(--t1); letter-spacing: -.2px; }
.ag-role { font-size: 10px; color: var(--t3); margin-top: 0; }
.ag-task {
  font-size: 10px; color: var(--t3); margin-top: 4px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ag-task.on { color: var(--t2); }
.act-bar { height: 2px; background: rgba(255,255,255,.05); border-radius: 1px; margin-top: 7px; overflow: hidden; }
.act-fill { height: 100%; border-radius: 1px; width: 0; transition: width .6s, background .4s; }
.act-fill.idle    { background: transparent; }
.act-fill.thinking{ background: #a78bfa; animation: sweep 1.5s ease-in-out infinite; }
.act-fill.working { background: #4ade80; }
.act-fill.done    { background: #4ade80; width: 100% !important; }
@keyframes sweep { 0%{transform:translateX(-100%);width:50%} 100%{transform:translateX(220%);width:50%} }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

/* Tabs */
.tabs {
  display: flex; align-items: center; gap: 0;
  border-bottom: 1px solid var(--bdr); flex-shrink: 0;
  padding: 0 20px;
  background: var(--bg);
}
.tab {
  font-size: 13px; font-weight: 500; color: var(--t3);
  padding: 11px 14px 10px; border: none; background: none; cursor: pointer;
  border-bottom: 1.5px solid transparent; margin-bottom: -1px;
  transition: color .15s; white-space: nowrap;
}
.tab:hover { color: var(--t2); }
.tab.active { color: var(--t1); border-bottom-color: var(--acc); }

/* Panels */
.tab-pane { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.tab-pane.active { display: flex; }

/* Results */
.feed {
  flex: 1; overflow-y: auto;
  padding: 18px 22px 12px;
  display: flex; flex-direction: column; gap: 10px;
}

/* Empty */
.empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; opacity: .2; pointer-events: none; text-align: center;
}
.empty-icon { font-size: 36px; margin-bottom: 2px; }
.empty h2 { font-size: 16px; font-weight: 600; letter-spacing: -.4px; }
.empty p  { font-size: 13px; color: var(--t2); line-height: 1.6; max-width: 260px; }

/* User bubble */
.user-row { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.user-ts { font-size: 10px; color: var(--t3); padding-right: 2px; }
.bubble {
  max-width: 62%;
  background: linear-gradient(145deg, #4f46e5 0%, #6d28d9 100%);
  color: rgba(255,255,255,.9); border-radius: 16px 16px 3px 16px;
  padding: 10px 15px; font-size: 13.5px; line-height: 1.55; letter-spacing: -.1px;
  box-shadow: 0 4px 20px rgba(79,70,229,.22);
}

/* Plan bar */
.plan {
  display: flex; align-items: flex-start; gap: 10px;
  background: rgba(109,91,250,.05); border: 1px solid rgba(109,91,250,.1);
  border-radius: 10px; padding: 9px 13px; font-size: 12px;
}
.plan-who  { color: #a78bfa; font-weight: 600; flex-shrink: 0; }
.plan-body { flex: 1; color: var(--t2); line-height: 1.55; }
.plan-ts   { flex-shrink: 0; font-size: 10px; color: var(--t3); margin-top: 1px; }

/* Result card */
.card {
  background: var(--bg2); border: 1px solid var(--bdr);
  border-radius: 14px; overflow: hidden;
  animation: in .28s cubic-bezier(.22,.68,0,1.2) both;
  transition: border-color .2s;
}
.card:hover { border-color: var(--bdr2); }
@keyframes in { from{opacity:0;transform:translateY(6px) scale(.99)} to{opacity:1;transform:none} }

.card-head {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px; cursor: pointer; user-select: none;
  transition: background .15s;
}
.card-head:hover { background: rgba(255,255,255,.025); }
.card-av {
  width: 26px; height: 26px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;
}
.card-name    { font-size: 12px; font-weight: 700; flex-shrink: 0; letter-spacing: -.1px; }
.card-preview { flex: 1; font-size: 12px; color: var(--t2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.card-ts      { font-size: 10px; color: var(--t3); flex-shrink: 0; font-variant-numeric: tabular-nums; }
.card-chev    { font-size: 10px; color: var(--t3); flex-shrink: 0; margin-left: 3px; transition: transform .2s; }
.card.open .card-chev { transform: rotate(180deg); }

.card-body   { display: none; padding: 0 14px 14px; }
.card.open .card-body { display: block; }
.card-scroll {
  max-height: 500px; overflow-y: auto; padding-right: 4px;
  border-top: 1px solid var(--bdr); padding-top: 12px;
}
.card-scroll::-webkit-scrollbar { width: 3px; }
.card-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

/* ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ */
.md { font-size: 13.5px; line-height: 1.75; color: rgba(255,255,255,.78); letter-spacing: -.05px; }
.md strong { font-weight: 600; color: var(--t1); }
.md em     { font-style: italic; color: var(--t2); }
.md h1 { font-size: 17px; font-weight: 700; color: var(--t1); margin: 14px 0 7px; letter-spacing: -.5px; }
.md h2 { font-size: 14px; font-weight: 600; color: var(--t1); margin: 12px 0 6px; letter-spacing: -.3px; }
.md h3 { font-size: 13px; font-weight: 600; color: var(--t1); margin: 10px 0 5px; }
.md p  { margin-bottom: 9px; }
.md ul, .md ol { padding-left: 20px; margin-bottom: 9px; }
.md li { margin-bottom: 4px; }
.md code {
  background: rgba(255,255,255,.09); padding: 2px 6px; border-radius: 4px;
  font-family: 'SF Mono','Fira Code',monospace; font-size: 11.5px; color: #c4b5fd;
}
.md pre {
  background: rgba(0,0,0,.4); border: 1px solid var(--bdr);
  border-radius: 10px; padding: 12px 14px; margin: 8px 0; overflow-x: auto;
}
.md pre code { background: none; padding: 0; font-size: 12px; color: rgba(255,255,255,.7); }
.md blockquote {
  border-left: 2px solid rgba(124,114,245,.45); padding-left: 13px;
  color: var(--t2); margin: 8px 0; font-style: italic;
}
.md hr { border: none; border-top: 1px solid var(--bdr); margin: 12px 0; }
.md .tw { overflow-x: auto; margin: 8px 0; border-radius: 9px; border: 1px solid var(--bdr); }
.md table { width: 100%; border-collapse: collapse; font-size: 12px; }
.md th, .md td { padding: 7px 12px; border-bottom: 1px solid var(--bdr); text-align: left; }
.md th { background: rgba(255,255,255,.04); font-weight: 600; color: var(--t1); border-bottom-color: var(--bdr2); }
.md tr:last-child td { border-bottom: none; }

/* ‚îÄ‚îÄ TASKS PANEL ‚îÄ‚îÄ */
.task-feed { flex: 1; overflow-y: auto; padding: 16px 22px; display: flex; flex-direction: column; gap: 8px; }
.task-card {
  background: var(--bg2); border: 1px solid var(--bdr);
  border-radius: 12px; padding: 12px 15px;
  display: flex; align-items: flex-start; gap: 12px;
  transition: border-color .2s;
}
.task-card:hover { border-color: var(--bdr2); }
.tc-left { flex: 1; min-width: 0; }
.tc-content { font-size: 13.5px; font-weight: 500; color: var(--t1); letter-spacing: -.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tc-meta    { font-size: 10.5px; color: var(--t3); margin-top: 4px; }
.tc-summary { font-size: 12px; color: var(--t2); margin-top: 5px; line-height: 1.5; }
.tc-badge {
  font-size: 10px; font-weight: 600; padding: 3px 9px;
  border-radius: 99px; letter-spacing: .2px; white-space: nowrap; flex-shrink: 0;
}
.tc-badge.processing { background: rgba(109,91,250,.16); color: #a78bfa; }
.tc-badge.done       { background: rgba(74,222,128,.12);  color: #4ade80; }
.tc-badge.pending    { background: rgba(251,191,36,.1);   color: #fbbf24; }
.task-empty { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; opacity:.2; text-align:center; }

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-area {
  flex-shrink: 0; padding: 12px 22px 15px;
  border-top: 1px solid var(--bdr);
  background: var(--bg);
}
.input-wrap {
  display: flex; align-items: flex-end; gap: 10px;
  background: var(--bg2); border: 1px solid var(--bdr);
  border-radius: 13px; padding: 10px 10px 10px 15px;
  transition: border-color .2s, box-shadow .2s;
}
.input-wrap:focus-within {
  border-color: rgba(124,106,245,.3);
  box-shadow: 0 0 0 3px rgba(124,106,245,.09);
}
textarea#ti {
  flex: 1; background: none; border: none; outline: none;
  color: var(--t1); font-family: var(--sans); font-size: 14px;
  resize: none; min-height: 22px; max-height: 100px;
  line-height: 1.5; letter-spacing: -.1px;
}
textarea#ti::placeholder { color: var(--t3); }
.send {
  width: 32px; height: 32px; border-radius: 9px; flex-shrink: 0;
  background: var(--acc); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center; color: #fff;
  transition: background .15s, transform .1s; font-size: 14px;
}
.send:hover { background: #6355d8; }
.send:active { transform: scale(.88); }
.input-hint { font-size: 10.5px; color: var(--t3); text-align: center; margin-top: 7px; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.08); border-radius: 2px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">‚ú¶</div>
    Agent Office
  </div>
  <div class="hdr-right">
    <div class="live-badge" id="liveEl"><div class="live-dot"></div>LIVE</div>
    <div class="clock" id="clockEl">00:00:00</div>
  </div>
</header>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sl">–ú–µ–Ω–µ–¥–∂–µ—Ä</div>

    <div class="mgr idle" id="card-manager">
      <div class="av40" style="background:rgba(167,139,250,.12)">üéØ</div>
      <div class="ag-info">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="ag-name">Manager</span>
          <span class="badge idle" id="badge-manager">IDLE</span>
        </div>
        <div class="ag-role">Orchestrator</div>
        <div class="ag-task" id="task-manager">–û–∂–∏–¥–∞–µ—Ç –∑–∞–¥–∞—á—É</div>
        <div class="act-bar"><div class="act-fill idle" id="fill-manager"></div></div>
      </div>
    </div>

    <div class="sl">–ö–æ–º–∞–Ω–¥–∞</div>
    <div id="workersGrid"></div>

  </aside>

  <!-- MAIN PANEL -->
  <section class="main-panel">

    <div class="tabs">
      <button class="tab active" id="tabChat"  onclick="switchTab('chat')">–ß–∞—Ç</button>
      <button class="tab"        id="tabTasks" onclick="switchTab('tasks')">–ó–∞–¥–∞—á–∏</button>
    </div>

    <!-- Chat -->
    <div class="tab-pane active" id="panelChat">
      <div class="feed" id="feed">
        <div class="empty" id="emptyEl">
          <div class="empty-icon">‚ú¶</div>
          <h2>–ö–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞</h2>
          <p>–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –µ—ë –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏</p>
        </div>
      </div>
    </div>

    <!-- Tasks -->
    <div class="tab-pane" id="panelTasks">
      <div class="task-feed" id="taskFeed">
        <div class="task-empty">
          <div style="font-size:28px;margin-bottom:4px">‚ó´</div>
          <div style="font-size:14px;font-weight:600;letter-spacing:-.3px;color:var(--t1)">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á</div>
          <div style="font-size:12px;color:var(--t2)">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤–∞—à–∏ –∑–∞–¥–∞—á–∏</div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="input-area">
      <div class="input-wrap">
        <textarea id="ti" rows="1" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É‚Ä¶"></textarea>
        <button class="send" id="sendBtn" title="Ctrl+Enter">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="input-hint">Ctrl+Enter ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç —Ä–∞–±–æ—Ç—É</div>
    </div>

  </section>
</div>

<script>
const WORKERS = [
  { key:'researcher', name:'Researcher', emoji:'üîç', color:'#38bdf8', bg:'rgba(56,189,248,.12)',  role:'Web Researcher' },
  { key:'writer',     name:'Writer',     emoji:'‚úçÔ∏è',  color:'#4ade80', bg:'rgba(74,222,128,.12)',  role:'Content Writer' },
  { key:'coder',      name:'Coder',      emoji:'üíª', color:'#facc15', bg:'rgba(250,204,21,.12)',  role:'Code Engineer'  },
  { key:'analyst',    name:'Analyst',    emoji:'üìä', color:'#fb7185', bg:'rgba(251,113,133,.12)', role:'Data Analyst'   },
];
const META = {
  manager:    {emoji:'üéØ',color:'#a78bfa',name:'Manager'},
  researcher: {emoji:'üîç',color:'#38bdf8',name:'Researcher'},
  writer:     {emoji:'‚úçÔ∏è', color:'#4ade80',name:'Writer'},
  coder:      {emoji:'üíª',color:'#facc15',name:'Coder'},
  analyst:    {emoji:'üìä',color:'#fb7185',name:'Analyst'},
};
const BL = {idle:'IDLE',thinking:'–î–£–ú–ê–ï–¢',working:'–ê–ö–¢–ò–í–ï–ù',done:'–ì–û–¢–û–í–û'};

/* Build worker rows */
document.getElementById('workersGrid').innerHTML = WORKERS.map(w => `
  <div class="ag-row idle" id="card-${w.key}">
    <div class="av28" style="background:${w.bg}">${w.emoji}</div>
    <div class="ag-info">
      <div style="display:flex;align-items:center;gap:6px">
        <span class="ag-name" style="font-size:12.5px">${w.name}</span>
        <span class="badge idle" id="badge-${w.key}">IDLE</span>
      </div>
      <div class="ag-role">${w.role}</div>
      <div class="ag-task" id="task-${w.key}">–°–≤–æ–±–æ–¥–µ–Ω</div>
    </div>
  </div>
`).join('');

function updateCard(a) {
  const isM   = a.key === 'manager';
  const card  = document.getElementById('card-'  + a.key);
  const badge = document.getElementById('badge-' + a.key);
  const task  = document.getElementById('task-'  + a.key);
  const fill  = document.getElementById('fill-'  + a.key);
  if (!card) return;
  card.className  = (isM ? 'mgr' : 'ag-row') + ' ' + a.status;
  badge.className = 'badge ' + a.status;
  badge.textContent = BL[a.status] || a.status.toUpperCase();
  task.textContent  = a.status !== 'idle' && a.task ? a.task : (a.status === 'idle' ? '–°–≤–æ–±–æ–¥–µ–Ω' : '');
  task.className    = 'ag-task' + (a.status !== 'idle' ? ' on' : '');
  if (fill) {
    fill.className = 'act-fill ' + a.status;
    fill.style.width = (a.status==='working'||a.status==='done') ? (a.progress||50)+'%' : '';
  }
}

/* ‚îÄ‚îÄ MARKDOWN ‚îÄ‚îÄ */
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function tbl(block) {
  const rows = block.trim().split('\n').filter(r => r.trim());
  if (rows.length < 2) return esc(block);
  const sep  = r => /^[\|\s\-:]+$/.test(r);
  const prow = r => r.replace(/^\||\|$/g,'').split('|').map(c => c.trim());
  let h = '<div class="tw"><table><thead><tr>';
  prow(rows[0]).forEach(c => h += `<th>${c}</th>`);
  h += '</tr></thead><tbody>';
  rows.slice(2).filter(r => !sep(r)).forEach(r => {
    h += '<tr>'; prow(r).forEach(c => h += `<td>${c}</td>`); h += '</tr>';
  });
  return h + '</tbody></table></div>';
}

function md(raw) {
  const cb = [];
  let t = raw.replace(/```[\w]*\n?([\s\S]*?)```/g, (_,c) => { cb.push(c.trim()); return `\x00${cb.length-1}\x00`; });
  t = t.replace(/((?:\|.+\n?)+)/g, b => tbl(b));
  t = t.replace(/`([^`]+)`/g, (_,c) => `<code>${esc(c)}</code>`);
  t = t.replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>');
  t = t.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
  t = t.replace(/^---+$/gm,'<hr>');
  t = t.replace(/^[-*]\s+(.+)$/gm,'<li>$1</li>');
  t = t.replace(/(<li>[\s\S]*?<\/li>)(\n(?!<li>)|$)/g, m => `<ul>${m}</ul>`);
  t = t.replace(/^>\s+(.+)$/gm,'<blockquote>$1</blockquote>');
  t = t.split(/\n{2,}/).map(c => {
    c = c.trim(); if (!c) return '';
    if (/^<(h[1-3]|ul|ol|hr|blockquote|pre|div|table)/.test(c)) return c;
    return `<p>${c.replace(/\n/g,'<br>')}</p>`;
  }).join('\n');
  t = t.replace(/\x00(\d+)\x00/g, (_,i) => `<pre><code>${esc(cb[+i])}</code></pre>`);
  return t;
}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
const seen = new Set();
function key(m) { return `${m.role}|${(m.content||'').slice(0,80)}`; }
let cn = 0;

function addMsg(msg, hist) {
  const k = key(msg);
  if (seen.has(k)) return;
  seen.add(k);
  const empty = document.getElementById('emptyEl');
  if (empty) empty.remove();
  const feed = document.getElementById('feed');
  const role = msg.role;
  const meta = META[role] || {emoji:'ü§ñ',color:'#888',name:msg.name||role};
  const col  = msg.color || meta.color;
  const emo  = msg.emoji || meta.emoji;

  if (role === 'user') {
    const el = document.createElement('div');
    el.className = 'user-row';
    el.innerHTML = `<div class="user-ts">${msg.time}</div><div class="bubble">${esc(msg.content)}</div>`;
    feed.appendChild(el);
    if (!hist) feed.scrollTop = feed.scrollHeight;
    return;
  }

  const isPlan = /^\*\*Plan:\*\*|^Plan:/i.test((msg.content||'').trim());
  if (role === 'manager' && isPlan) {
    const txt = msg.content.replace(/^\*\*Plan:\*\*\s*/,'').replace(/^Plan:\s*/i,'');
    const el = document.createElement('div');
    el.className = 'plan';
    el.innerHTML = `<span class="plan-who">üéØ Manager</span><span class="plan-body">${esc(txt)}</span><span class="plan-ts">${msg.time}</span>`;
    feed.appendChild(el);
    if (!hist) feed.scrollTop = feed.scrollHeight;
    return;
  }

  const id = 'c' + (++cn);
  const preview = (msg.content||'').replace(/[#*`|\n]/g,' ').replace(/\s+/g,' ').trim().slice(0,100);
  const el = document.createElement('div');
  el.className = 'card open';
  el.style.borderColor = col + '28';
  el.innerHTML = `
    <div class="card-head" onclick="toggle('${id}',this.parentElement)"
         style="background:linear-gradient(90deg,${col}0d 0%,transparent 55%)">
      <div class="card-av" style="background:${col}1a">${emo}</div>
      <span class="card-name" style="color:${col}">${esc(msg.name||meta.name)}</span>
      <span class="card-preview">${esc(preview)}${msg.content.length>100?'‚Ä¶':''}</span>
      <span class="card-ts">${msg.time}</span>
      <span class="card-chev">‚ñæ</span>
    </div>
    <div class="card-body" id="${id}">
      <div class="card-scroll"><div class="md">${md(msg.content)}</div></div>
    </div>`;
  feed.querySelectorAll('.card.open').forEach(c => c.classList.remove('open'));
  feed.appendChild(el);
  if (!hist) feed.scrollTop = feed.scrollHeight;
}

function toggle(id, card) { card.classList.toggle('open'); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
function switchTab(tab) {
  document.getElementById('tabChat').classList.toggle('active', tab==='chat');
  document.getElementById('tabTasks').classList.toggle('active', tab==='tasks');
  document.getElementById('panelChat').classList.toggle('active', tab==='chat');
  document.getElementById('panelTasks').classList.toggle('active', tab==='tasks');
  if (tab==='tasks') loadTasks();
}

/* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
async function loadTasks() {
  try {
    const r = await fetch('/api/tasks'); const d = await r.json();
    renderTasks(d.tasks || []);
  } catch(e) {}
}
function renderTasks(tasks) {
  const el = document.getElementById('taskFeed');
  if (!tasks.length) return;
  el.innerHTML = tasks.map(t => {
    const d  = new Date(t.created_at);
    const ds = d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}) + ' ¬∑ '
             + d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    const st = t.status || 'processing';
    const sl = st==='done'?'–ì–æ—Ç–æ–≤–æ':st==='processing'?'–í —Ä–∞–±–æ—Ç–µ':'–û–∂–∏–¥–∞–Ω–∏–µ';
    const sum = t.summary ? `<div class="tc-summary">${esc(t.summary)}</div>` : '';
    return `<div class="task-card"><div class="tc-left">
      <div class="tc-content">${esc(t.content)}</div>
      <div class="tc-meta">${ds}</div>${sum}
    </div><span class="tc-badge ${st}">${sl}</span></div>`;
  }).join('');
}

/* ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ */
let ws;
function connect() {
  const p = location.protocol==='https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${p}://${location.host}/ws`);
  const liv = document.getElementById('liveEl');
  ws.onopen  = () => { liv.className='live-badge'; liv.innerHTML='<div class="live-dot"></div>LIVE'; };
  ws.onclose = () => { liv.className='live-badge off'; liv.innerHTML='<div class="live-dot"></div>OFFLINE'; setTimeout(connect,3000); };
  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.type==='init') {
      d.agents.forEach(updateCard);
      d.history.forEach(m => addMsg(m,true));
      const f = document.getElementById('feed');
      f.scrollTop = f.scrollHeight;
    } else if (d.type==='agents') {
      d.agents.forEach(updateCard);
    } else if (d.type==='chat') {
      addMsg(d.message, false);
    } else if (d.type==='tasks_update') {
      if (document.getElementById('panelTasks').classList.contains('active')) loadTasks();
    }
  };
}

/* ‚îÄ‚îÄ SEND ‚îÄ‚îÄ */
function send() {
  const inp = document.getElementById('ti');
  const txt = inp.value.trim();
  if (!txt || !ws || ws.readyState!==1) return;
  ws.send(JSON.stringify({type:'task',content:txt}));
  inp.value=''; inp.style.height='auto';
}
document.getElementById('sendBtn').addEventListener('click', send);
document.getElementById('ti').addEventListener('keydown', e => {
  if (e.key==='Enter' && (e.ctrlKey||e.metaKey)) { e.preventDefault(); send(); }
  setTimeout(() => {
    const el = e.target; el.style.height='auto';
    el.style.height = Math.min(el.scrollHeight,100)+'px';
  });
});

/* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
(function tick() {
  const n = new Date();
  document.getElementById('clockEl').textContent =
    [n.getHours(),n.getMinutes(),n.getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');
  setTimeout(tick,1000);
})();

connect();
</script>
</body>
</html>
